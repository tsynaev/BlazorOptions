@using System.Globalization
@using BlazorOptions.ViewModels
@using Microsoft.AspNetCore.Components.Web

@if (ViewModel is not null)
{
    <MudCard>
        <MudCardHeader>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="flex-grow-1">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudCheckBox T="bool"
                                 Value="@ViewModel.IsVisible"
                                 ValueChanged="async visible => await ViewModel.SetVisibilityAsync(visible)"/>
                    <MudText Typo="Typo.h6" Style="@($"color:{ViewModel.Color};")">@ViewModel.Name</MudText>
                </MudStack>
                <MudSpacer/>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudTooltip Text="Duplicate portfolio">
                        <MudIconButton Icon="@Icons.Material.Filled.FileCopy"
                                       Color="Color.Default"
                                       OnClick="async () => await ViewModel.DuplicateCollectionAsync()"/>
                    </MudTooltip>
                    <MudTooltip Text="Copy symbols to closed positions">
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                       Color="Color.Default"
                                       Disabled="@(ViewModel.Legs.Count == 0)"
                                       OnClick="async () => await ViewModel.CopySymbolsToClosedPositionsAsync()"/>
                    </MudTooltip>
                    <MudTooltip Text="Load exchange positions">
                        <MudIconButton Icon="@Icons.Material.Filled.CloudDownload"
                                       Color="Color.Default"
                                       OnClick="async () => await ViewModel.LoadBybitPositionsAsync()"/>
                    </MudTooltip>
                    <MudTooltip Text="Add leg">
                        <MudIconButton Icon="@Icons.Material.Filled.AddCircle"
                                       Color="Color.Primary"
                                       OnClick="async () => await ViewModel.AddLegAsync()"/>
                    </MudTooltip>
                    <MudTooltip Text="Portfolio settings">
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert"
                                       Color="Color.Default"
                                       OnClick="async () => await ViewModel.OpenSettingsAsync()"/>
                    </MudTooltip>
                </MudStack>
            </MudStack>

        </MudCardHeader>
        <MudCardContent>
            <MudStack Spacing="2">
                <MudText Typo="Typo.caption" Class="leg-greeks-total">
                    Δ @FormatGreek(ViewModel.TotalDelta) · Γ @FormatGreek(ViewModel.TotalGamma) · ν @FormatGreek(ViewModel.TotalVega) · Θ @FormatGreek(ViewModel.TotalTheta)
                </MudText>
                @foreach (var group in ViewModel.GroupedLegs)
                {
                    <MudStack Spacing="1" Class="leg-group" @key="group.ExpirationDate">
                        <MudText Typo="Typo.subtitle2" Class="leg-group-title">@FormatExpiration(group.ExpirationDate)</MudText>
                        <MudGrid Class="leg-grid">
                            @foreach (var leg in group.Legs)
                            {
                                <MudItem xs="12" sm="6" md="4" lg="3" @key="leg.Leg.Id">
                                    <LegCard ViewModel="leg" />
                                </MudItem>
                            }
                        </MudGrid>
                    </MudStack>
                }
            </MudStack>
            <MudCardActions>
                <QuickAddPanel ViewModel="ViewModel.QuickAdd"/>
            </MudCardActions>
        </MudCardContent>
    </MudCard>
}

@code {
    [Parameter, EditorRequired] public LegsCollectionViewModel ViewModel { get; set; }

    private static string FormatExpiration(DateTime? date)
    {
        return date.HasValue ? date.Value.ToString("dd.MM.yy") : "No expiration";
    }

    private static string FormatGreek(decimal value)
    {
        return value.ToString("0.###", CultureInfo.InvariantCulture);
    }
}

<style>
    .portfolio-color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .portfolio-color-picker input {
        padding: 0;
        width: 28px;
        height: 28px;
    }

    .portfolio-color-picker .mud-input-root {
        padding: 0;
    }

    .portfolio-color-picker .mud-input-underline,
    .portfolio-color-picker .mud-input-outlined-border {
        border: 0;
    }

    .iv-column {
        width: 110px;
        min-width: 110px;
    }

    .iv-input .mud-input-root {
        max-width: 90px;
    }

    .iv-chain {
        display: block;
        margin-top: 2px;
        line-height: 1.1;
    }

    .price-input .mud-input-root {
        max-width: 120px;
    }

    .price-chain {
        display: block;
        margin-top: 2px;
        line-height: 1.1;
    }

    .leg-group-title {
        text-transform: uppercase;
        letter-spacing: 0.04em;
        opacity: 0.8;
    }

    .leg-grid {
        width: 100%;
    }

    .leg-greeks-total {
        opacity: 0.8;
    }
</style>
