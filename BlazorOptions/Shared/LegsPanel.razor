@using BlazorOptions.ViewModels
@using Microsoft.AspNetCore.Components.Web

<MudCard>
    <MudCardHeader>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="flex-grow-1">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudCheckBox T="bool"
                             Value="@ViewModel.IsVisible"
                             ValueChanged="async visible => await ViewModel.SetVisibilityAsync(visible)" />
                <MudPaper Class="portfolio-color-swatch" Style="@($"background-color:{ViewModel.Color};")" Elevation="0" />
                <MudText Typo="Typo.h6">@ViewModel.Name</MudText>
            </MudStack>
            <MudSpacer />
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudTextField T="string"
                              @bind-Value="ViewModel.QuickLegInput"
                              Label="Quick add"
                              Placeholder="+1 C 3400"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Immediate="true"
                              OnKeyDown="ViewModel.OnQuickLegKeyDown"
                              Class="quick-leg-input"
                              Disabled="@(!ViewModel.HasActivePosition)" />
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Disabled="@(!ViewModel.HasActivePosition)"
                           OnClick="async () => await ViewModel.AddQuickLegAsync()">
                    Add
                </MudButton>
                <MudTooltip Text="Duplicate portfolio">
                    <MudIconButton Icon="@Icons.Material.Filled.FileCopy"
                                   Color="Color.Default"
                                   Disabled="@(!ViewModel.HasActivePosition)"
                                   OnClick="async () => await ViewModel.DuplicateCollectionAsync()" />
                </MudTooltip>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           StartIcon="@Icons.Material.Filled.CloudDownload"
                           Disabled="@(!ViewModel.HasActivePosition)"
                           OnClick="async () => await ViewModel.LoadBybitPositionsAsync()">
                    Load Positions
                </MudButton>
                <MudTooltip Text="Add leg">
                    <MudIconButton Icon="@Icons.Material.Filled.AddCircle"
                                   Color="Color.Primary"
                                   Disabled="@(!ViewModel.HasActivePosition)"
                                   OnClick="async () => await ViewModel.AddLegAsync()" />
                </MudTooltip>
                <MudTooltip Text="Portfolio settings">
                    <MudIconButton Icon="@Icons.Material.Filled.MoreVert"
                                   Color="Color.Default"
                                   Disabled="@(!ViewModel.HasActivePosition)"
                                   OnClick="async () => await ViewModel.OpenSettingsAsync()" />
                </MudTooltip>
            </MudStack>
        </MudStack>

    </MudCardHeader>
    <MudCardContent>
        <MudTable Items="@ViewModel.Legs" Dense="true" Hover="true" Class="leg-table">
            <HeaderContent>
                <MudTh>Include</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Strike</MudTh>
                <MudTh>Expiration</MudTh>
                <MudTh>Size</MudTh>
                <MudTh>Price</MudTh>
                <MudTh>Temp P/L</MudTh>
                <MudTh>IV</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Include">
                    <MudCheckBox T="bool"
                                 Value="@context.IsIncluded"
                                 ValueChanged="async checkedValue => await ViewModel.UpdateLegIncludedAsync(context, checkedValue)" />
                </MudTd>
                <MudTd DataLabel="Type">
                <MudSelect T="LegType" Value="@context.Type" ValueChanged="async type => await ViewModel.UpdateLegTypeAsync(context, type)" Dense="true" Disabled="@context.IsReadOnly">
                        @foreach (var type in ViewModel.LegTypes)
                        {
                            <MudSelectItem Value="@type">@type</MudSelectItem>
                        }
                    </MudSelect>
                </MudTd>
                <MudTd DataLabel="Strike">
                <MudNumericField T="double?" Value="@context.Strike" ValueChanged="async value => await ViewModel.UpdateLegStrikeAsync(context, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="USDT" Disabled="@context.IsReadOnly" />
                </MudTd>
                <MudTd DataLabel="Expiration">
                <MudDatePicker Date="context.ExpirationDate"
                               DateChanged="date => ViewModel.UpdateLegExpirationAsync(context, date)"
                               DateFormat="yyyy-MM-dd"
                               Class="full-width"
                               Disabled="@context.IsReadOnly" />
                </MudTd>
                <MudTd DataLabel="Size">
                <MudNumericField T="double" Value="@context.Size" ValueChanged="async value => await ViewModel.UpdateLegSizeAsync(context, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Disabled="@context.IsReadOnly" />
                </MudTd>
                <MudTd DataLabel="Price">
                <MudNumericField T="double" Value="@context.Price" ValueChanged="async value => await ViewModel.UpdateLegPriceAsync(context, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="USDT" Disabled="@context.IsReadOnly" />
                </MudTd>
                <MudTd DataLabel="Temp P/L">
                    <MudText Typo="Typo.body2" Color="@(context.TemporaryPnl >= 0 ? Color.Success : Color.Error)">
                        @context.TemporaryPnl.ToString("0.##")
                    </MudText>
                </MudTd>
                <MudTd DataLabel="IV">
                <MudNumericField T="double?" Value="@context.ImpliedVolatility" ValueChanged="async value => await ViewModel.UpdateLegIvAsync(context, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="%" Disabled="@context.IsReadOnly" />
                </MudTd>
                <MudTd DataLabel="Actions" Style="text-align:right;">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="async () => await ViewModel.RemoveLegAsync(context)" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    [Parameter, EditorRequired] public LegsCollectionModel Collection { get; set; } = default!;

    [Inject] private LegsCollectionViewModelFactory ViewModelFactory { get; set; } = default!;

    private LegsCollectionViewModel ViewModel { get; set; } = default!;

    protected override void OnParametersSet()
    {
        if (ViewModel is null || ViewModel.Collection.Id != Collection.Id)
        {
            ViewModel = ViewModelFactory.Create(Collection);
        }
    }
}

<style>
    .portfolio-color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .portfolio-color-picker input {
        padding: 0;
        width: 28px;
        height: 28px;
    }

    .portfolio-color-picker .mud-input-root {
        padding: 0;
    }

    .portfolio-color-picker .mud-input-underline,
    .portfolio-color-picker .mud-input-outlined-border {
        border: 0;
    }
</style>
