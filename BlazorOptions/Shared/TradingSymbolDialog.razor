@using BlazorOptions.ViewModels
@using MudBlazor
@using System.Globalization
<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudDatePicker Date="@_sinceDate"
                               DateChanged="OnSinceDateChanged"
                               Label="Since date"
                               DateFormat="yyyy-MM-dd"
                               Clearable="true" />
                <MudTimePicker Time="@_sinceTime"
                               TimeChanged="OnSinceTimeChanged"
                               Label="Since time"
                               Clearable="true" />
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           Disabled="@(!_sinceDate.HasValue && !_sinceTime.HasValue)"
                           OnClick="ClearSince">
                    Clear
                </MudButton>
            </MudStack>
            <MudSwitch T="bool" @bind-Value="_showRaw" Color="Color.Primary" Label="Raw" />

            @if (_showRaw)
            {
                @if (string.IsNullOrWhiteSpace(RawJson))
                {
                    <MudText Typo="Typo.body2">No raw data found for this symbol.</MudText>
                }
                else
                {
                    <MudTextField T="string"
                                  Value="RawJson"
                                  ReadOnly="true"
                                  Lines="26"
                                  Variant="Variant.Outlined"
                                  Class="w-100"
                                  Style="font-family: Consolas, 'Courier New', monospace;" />
                }
            }
            else if (_filteredTrades.Count == 0)
            {
                <MudText Typo="Typo.body2">No trades found for this symbol.</MudText>
            }
            else
            {
                <MudDataGrid T="TradingHistoryEntry"
                             Items="_filteredTrades"
                             Dense="true"
                             Hover="true"
                             FixedHeader="true"
                             Height="420px">
                    <Columns>
                        <TemplateColumn Title="Date">
                            <CellTemplate>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">@FormatTimestamp(context.Item.Timestamp)</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.TransactionType</MudText>
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Trade">
                            <CellTemplate>
                                @($"{context.Item.Side} {context.Item.TransactionType} {context.Item.Size} {context.Item.Symbol}")
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Price">
                            <CellTemplate>
                                @context.Item.Price
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Value">
                            <CellTemplate>
                                @($"{FormatValue(context.Item.Size, context.Item.Price)} {context.Item.Currency}")
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Fee">
                            <CellTemplate>
                                @($"{context.Item.Fee} {context.Item.Currency}")
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.Calculated.SizeAfter" Title="Size after" />
                        <PropertyColumn Property="x => x.Calculated.AvgPriceAfter" Title="Avg price after" />
                        <PropertyColumn Property="x => x.Calculated.RealizedPnl" Title="Realized PnL" />
                        <PropertyColumn Property="x => x.Calculated.CumulativePnl" Title="Cumulative PnL" />
                    </Columns>
                </MudDataGrid>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }

    [Parameter] public string Symbol { get; set; } = string.Empty;
    [Parameter] public string Category { get; set; } = string.Empty;
    [Parameter] public IReadOnlyList<TradingHistoryEntry> Trades { get; set; } = Array.Empty<TradingHistoryEntry>();
    [Parameter] public string RawJson { get; set; } = string.Empty;
    [Parameter] public DateTime? SinceDateTime { get; set; }

    private string Title => string.IsNullOrWhiteSpace(Symbol)
        ? "Symbol trades"
        : string.IsNullOrWhiteSpace(Category)
            ? $"Trades for {Symbol}"
            : $"Trades for {Symbol} ({Category})";
    private bool _showRaw;
    private DateTime? _sinceDate;
    private TimeSpan? _sinceTime;
    private IReadOnlyList<TradingHistoryEntry> _filteredTrades = Array.Empty<TradingHistoryEntry>();

    protected override void OnParametersSet()
    {
        if (SinceDateTime.HasValue)
        {
            _sinceDate = SinceDateTime.Value.Date;
            _sinceTime = SinceDateTime.Value.TimeOfDay;
        }
        ApplyFilter();
    }

    private static string FormatTimestamp(long? timestamp)
    {
        if (!timestamp.HasValue || timestamp.Value <= 0)
        {
            return "N/A";
        }

        try
        {
            return DateTimeOffset.FromUnixTimeMilliseconds(timestamp.Value)
                .ToLocalTime()
                .ToString("g");
        }
        catch
        {
            return "N/A";
        }
    }

    private static string FormatValue(decimal qty, decimal price)
    {
        return (qty * price).ToString("0.##########", CultureInfo.InvariantCulture);
    }

    private void Close()
    {
        MudDialog?.Close();
    }

    private void OnSinceDateChanged(DateTime? value)
    {
        _sinceDate = value?.Date;
        ApplyFilter();
    }

    private void OnSinceTimeChanged(TimeSpan? value)
    {
        _sinceTime = value;
        ApplyFilter();
    }

    private void ClearSince()
    {
        _sinceDate = null;
        _sinceTime = null;
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        var since = BuildSinceTimestamp();
        if (!since.HasValue)
        {
            _filteredTrades = Trades;
            return;
        }

        var cutoffMs = since.Value.ToUnixTimeMilliseconds();
        var filtered = Trades
            .Where(item => item.Timestamp.HasValue && item.Timestamp.Value >= cutoffMs)
            .ToList();

        _filteredTrades = TradingHistoryViewModel.RecalculateForSymbol(filtered);
    }

    private DateTimeOffset? BuildSinceTimestamp()
    {
        if (!_sinceDate.HasValue && !_sinceTime.HasValue)
        {
            return null;
        }

        var date = _sinceDate ?? DateTime.Today;
        var time = _sinceTime ?? TimeSpan.Zero;
        var local = DateTime.SpecifyKind(date.Date + time, DateTimeKind.Local);
        return new DateTimeOffset(local);
    }
}
