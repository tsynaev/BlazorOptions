@implements IDisposable
@using MudBlazor
@using System.Globalization
@using System.ComponentModel
@using BlazorOptions.ViewModels
<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudSwitch T="bool" @bind-Value="_showRaw" Color="Color.Primary" Label="Raw" />

            @if (ViewModel.IsLoading)
            {
                <MudText Typo="Typo.body2">Loading trades...</MudText>
            }
            else if (!string.IsNullOrWhiteSpace(ViewModel.ErrorMessage))
            {
                <MudAlert Severity="Severity.Error">@ViewModel.ErrorMessage</MudAlert>
            }
            else if (_showRaw)
            {
                @if (string.IsNullOrWhiteSpace(ViewModel.RawJson))
                {
                    <MudText Typo="Typo.body2">No raw data found for this symbol.</MudText>
                }
                else
                {
                    <MudTextField T="string"
                                  Value="ViewModel.RawJson"
                                  ReadOnly="true"
                                  Lines="26"
                                  Variant="Variant.Outlined"
                                  Class="w-100"
                                  Style="font-family: Consolas, 'Courier New', monospace;" />
                }
            }
            else if (ViewModel.Trades.Count == 0)
            {
                <MudText Typo="Typo.body2">No trades found for this symbol.</MudText>
            }
            else
            {
                <MudDataGrid T="TradingHistoryEntry"
                             Items="ViewModel.Trades"
                             Dense="true"
                             Hover="true"
                             FixedHeader="true"
                             Height="420px">
                    <Columns>
                        <TemplateColumn Title="Date">
                            <CellTemplate>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2">@FormatTimestamp(context.Item.Timestamp)</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.TransactionType</MudText>
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Trade">
                            <CellTemplate>
                                @($"{context.Item.Side} {context.Item.TransactionType} {context.Item.Size} {context.Item.Symbol}")
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Price">
                            <CellTemplate>
                                @context.Item.Price
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Value">
                            <CellTemplate>
                                @($"{FormatValue(context.Item.Size, context.Item.Price)} {context.Item.Currency}")
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn Title="Fee">
                            <CellTemplate>
                                @($"{context.Item.Fee} {context.Item.Currency}")
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.Calculated.SizeAfter" Title="Size after" />
                        <PropertyColumn Property="x => x.Calculated.AvgPriceAfter" Title="Avg price after" />
                        <PropertyColumn Property="x => x.Calculated.RealizedPnl" Title="Realized PnL" />
                        <PropertyColumn Property="x => x.Calculated.CumulativePnl" Title="Cumulative PnL" />
                    </Columns>
                </MudDataGrid>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance? MudDialog { get; set; }

    [Parameter, EditorRequired] public TradingSymbolDialogViewModel ViewModel { get; set; } = default!;
    private bool _showRaw;
    private PropertyChangedEventHandler? _viewModelChangedHandler;

    protected override void OnInitialized()
    {
        _viewModelChangedHandler = (_, _) => InvokeAsync(StateHasChanged);
        ViewModel.PropertyChanged += _viewModelChangedHandler;
    }

    public void Dispose()
    {
        if (_viewModelChangedHandler is not null)
        {
            ViewModel.PropertyChanged -= _viewModelChangedHandler;
        }
    }

    private static string FormatTimestamp(long? timestamp)
    {
        if (!timestamp.HasValue || timestamp.Value <= 0)
        {
            return "N/A";
        }

        try
        {
            return DateTimeOffset.FromUnixTimeMilliseconds(timestamp.Value)
                .ToLocalTime()
                .ToString("g");
        }
        catch
        {
            return "N/A";
        }
    }

    private static string FormatValue(decimal qty, decimal price)
    {
        return (qty * price).ToString("0.##########", CultureInfo.InvariantCulture);
    }

    private void Close()
    {
        MudDialog?.Close();
    }
}
