@using System.Globalization
@using System.Linq
@using BlazorOptions.ViewModels
@using MudBlazor
@inject IDialogService DialogService
@implements IDisposable

<MudTd DataLabel="Include" Class="leg-desktop include-cell">
    <MudCheckBox T="bool"
                 Value="@ViewModel.Leg.IsIncluded"
                 ValueChanged="ViewModel.UpdateLegIncludedAsync" />
</MudTd>
<MudTd DataLabel="Type" Class="leg-desktop">
    <MudSelect T="LegType" Value="@ViewModel.Leg.Type" ValueChanged="ViewModel.UpdateLegTypeAsync" Dense="true" Disabled="@ViewModel.Leg.IsReadOnly">
        @foreach (var type in ViewModel.LegTypes)
        {
            <MudSelectItem Value="@type">@type</MudSelectItem>
        }
    </MudSelect>
</MudTd>
<MudTd DataLabel="Strike" Class="leg-desktop strike-cell">
    @{

        var strikeIsInList = ViewModel.Leg.Strike.HasValue 
                             && ViewModel.AvailableStrikes.Any(item => Math.Abs(item - ViewModel.Leg.Strike.Value) < 0.01m);
    }
    <MudSelect T="decimal?"
               Value="@ViewModel.Leg.Strike"
               ValueChanged="ViewModel.UpdateLegStrikeAsync"
               Dense="true"
               Variant="Variant.Outlined"
               Margin="Margin.Dense"
               Disabled="@(ViewModel.Leg.IsReadOnly || ViewModel.Leg.Type == LegType.Future || !ViewModel.Leg.ExpirationDate.HasValue)"
               Adornment="Adornment.End"
               AdornmentText="USDT">
        @if (ViewModel.Leg.Strike.HasValue && !strikeIsInList)
        {
            <MudSelectItem T="decimal?" Value="@ViewModel.Leg.Strike" Disabled="true">@FormatStrike(ViewModel.Leg.Strike)</MudSelectItem>
        }
        @if (!ViewModel.Leg.ExpirationDate.HasValue)
        {
            <MudSelectItem T="decimal?" Disabled="true">Select expiration first</MudSelectItem>
        }
        else if (ViewModel.AvailableStrikes.Count == 0)
        {
            <MudSelectItem T="decimal?" Disabled="true">No strikes for selected expiration</MudSelectItem>
        }
        else
        {
            @foreach (var strike in ViewModel.AvailableStrikes)
            {
                <MudSelectItem T="decimal?" Value="@strike">@FormatStrike(strike)</MudSelectItem>
            }
        }
    </MudSelect>
</MudTd>
<MudTd DataLabel="Expiration" Class="leg-desktop expiration-cell">

    <MudSelect T="DateTime?"
               Value="@ViewModel.Leg.ExpirationDate"
               ValueChanged="ViewModel.UpdateLegExpirationAsync"
               Dense="true"
               Variant="Variant.Outlined"
               Margin="Margin.Dense"
               Disabled="@(ViewModel.Leg.IsReadOnly || (ViewModel.AvailableExpirations.Count == 0))"
               Class="full-width">

        @if (ViewModel.AvailableExpirations.Count == 0)
        {
            <MudSelectItem T="DateTime?" Disabled="true">
                @(ViewModel.Leg.Type == LegType.Future ? "No expirations" : "No expirations available")
            </MudSelectItem>
        }
        else
        {
            @foreach (var expiration in ViewModel.AvailableExpirations)
            {
                <MudSelectItem T="DateTime?" Value="@expiration">@FormatExpiration(expiration)</MudSelectItem>
            }
        }
    </MudSelect>
</MudTd>
<MudTd DataLabel="Size" Class="leg-desktop">
    <MudNumericField T="decimal" Value="@ViewModel.Leg.Size" ValueChanged="ViewModel.UpdateLegSizeAsync" Variant="Variant.Outlined" Margin="Margin.Dense" Disabled="@ViewModel.Leg.IsReadOnly" />
</MudTd>
<MudTd DataLabel="Price" Class="leg-desktop">
    <MudStack Spacing="0">
        @{
            var placeholderPrice = ViewModel.PlaceholderPrice;
            var placeholder = placeholderPrice.HasValue ? placeholderPrice.Value.ToString("0.##") : null;
        }
        <MudNumericField T="decimal?"
                         Value="@ViewModel.Leg.Price"
                         ValueChanged="async value => await ViewModel.UpdateLegPriceAsync(value)"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Adornment="Adornment.End"
                         AdornmentText="USDT"
                         Placeholder="@placeholder"
                         Disabled="@ViewModel.Leg.IsReadOnly"
                         Class="price-input" />
        @{
            var markPrice = ViewModel.MarkPrice;
        }
        @if (ViewModel.IsLive && (ViewModel.Bid.HasValue || ViewModel.Ask.HasValue))
        {
            <MudText Typo="Typo.caption" Class="price-chain">
                <span class="price-bid">@FormatPrice(ViewModel.Bid)<span class="price-diff">@FormatDiff(ViewModel.Bid, markPrice)</span></span>
                <span class="price-sep">|</span>
                <span class="price-mark">@FormatPrice(markPrice)</span>
                <span class="price-sep">|</span>
                <span class="price-ask"><span class="price-diff">@FormatDiff(ViewModel.Ask, markPrice)</span> @FormatPrice(ViewModel.Ask)</span>
            </MudText>
        }
    </MudStack>
</MudTd>
<MudTd DataLabel="Temp P/L" Class="leg-desktop">
        @{
            var tempPnl = ViewModel.TempPnl;
            var tempPnlPercent = ViewModel.TempPnlPercent;
        }
    <MudStack Spacing="0">
        <MudText Typo="Typo.body2" Color="@(tempPnl >= 0 ? Color.Success : Color.Error)">
            @FormatPrice(tempPnl)
        </MudText>
        @if (tempPnlPercent.HasValue)
        {
            <MudText Typo="Typo.caption" Class="temp-pnl-percent">
                @($"{tempPnlPercent.Value:0.00}%")
            </MudText>
        }
    </MudStack>
</MudTd>
<MudTd DataLabel="IV" Class="leg-desktop iv-column">
        @{
            var chainIv = ViewModel.ChainIv;
        }
    <MudStack Spacing="0">
        <MudNumericField T="decimal?" Value="@ViewModel.Leg.ImpliedVolatility" ValueChanged="ViewModel.UpdateLegIvAsync" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="%" Disabled="@ViewModel.Leg.IsReadOnly" Class="iv-input" />
        @if (chainIv.HasValue)
        {
            <MudText Typo="Typo.caption" Class="iv-chain">Chain: @chainIv.Value.ToString("0.##")%</MudText>
        }
    </MudStack>
</MudTd>
<MudTd DataLabel="Actions" Class="leg-desktop" Style="text-align:right;">
    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="async () => await ViewModel.RemoveLegAsync()" />
</MudTd>
<MudTd Class="leg-mobile-cell" ColSpan="9">
    <MudPaper Elevation="1" Class="mobile-leg-card">
        <MudStack Spacing="1">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.subtitle2">@BuildLegSummary()</MudText>
                    <MudText Typo="Typo.overline" Class="mobile-leg-subtitle">@BuildLegSubtitle()</MudText>
                </MudStack>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Color="Color.Primary"
                               Size="Size.Medium"
                               OnClick="OpenEditDialogAsync"
                               Disabled="@ViewModel.Leg.IsReadOnly" />
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.caption">
                    Price: @FormatPrice(ViewModel.Leg.Price ?? ViewModel.PlaceholderPrice)
                </MudText>
                <MudText Typo="Typo.caption">
                    IV: @FormatIv(ViewModel.Leg.ImpliedVolatility ?? ViewModel.ChainIv)
                </MudText>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.caption" Color="@(ViewModel.TempPnl >= 0 ? Color.Success : Color.Error)">
                    Temp P/L: @FormatPrice(ViewModel.TempPnl)
                </MudText>
                @if (ViewModel.TempPnlPercent.HasValue)
                {
                    <MudText Typo="Typo.caption">
                        (@($"{ViewModel.TempPnlPercent.Value:0.00}%"))
                    </MudText>
                }
                @if (ViewModel.IsLive && (ViewModel.Bid.HasValue || ViewModel.Ask.HasValue))
                {
                    <MudText Typo="Typo.caption">
                        Bid: @FormatPrice(ViewModel.Bid) | Ask: @FormatPrice(ViewModel.Ask)
                    </MudText>
                }
            </MudStack>
        </MudStack>
    </MudPaper>
</MudTd>

@code {
    [Parameter, EditorRequired] public LegViewModel ViewModel { get; set; } = default!;

    protected override void OnInitialized()
    {
        ViewModel.Changed += HandleViewModelChanged;
        ViewModel.Removed += HandleViewModelRemoved;
    }

    public void Dispose()
    {
        ViewModel.Changed -= HandleViewModelChanged;
        ViewModel.Removed -= HandleViewModelRemoved;
    }

    private void HandleViewModelChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private Task HandleViewModelRemoved()
    {
        return InvokeAsync(StateHasChanged);
    }

    private static string FormatPrice(decimal? price)
    {
        return price.HasValue ? price.Value.ToString("0.00") : "-";
    }

    private static string FormatDiff(decimal? price, decimal? mark)
    {
        if (!price.HasValue || !mark.HasValue)
        {
            return string.Empty;
        }

        var diff = price.Value - mark.Value;
        if (Math.Abs(diff) < 0.0001m)
        {
            return string.Empty;
        }

        var sign = diff > 0 ? "+" : string.Empty;
        return $"({sign}{diff:0.00})";
    }

    private static string FormatStrike(decimal? strike)
    {
        return strike.HasValue ? strike.Value.ToString("0.00") : string.Empty;
    }

    private static string FormatExpiration(DateTime? date)
    {
        return date.HasValue ? date.Value.ToString("yyyy-MM-dd") : string.Empty;
    }

    private async Task OpenEditDialogAsync()
    {
        var parameters = new DialogParameters
        {
            { nameof(LegEditDialog.ViewModel), ViewModel }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<LegEditDialog>("Edit leg", parameters, options);
    }

    private string BuildLegSummary()
    {
        var direction = ViewModel.Leg.Size >= 0 ? "Buy" : "Sell";
        var typeLabel = ViewModel.Leg.Type.ToString().ToUpperInvariant();
        var size = Math.Abs(ViewModel.Leg.Size);
        var strike = ViewModel.Leg.Strike.HasValue
            ? Math.Round(ViewModel.Leg.Strike.Value).ToString("0", CultureInfo.InvariantCulture)
            : "ATM";
        return $"{direction} {size:0.##} {typeLabel} {strike}";
    }

    private string BuildLegSubtitle()
    {
        return ViewModel.Leg.ExpirationDate.HasValue
            ? ViewModel.Leg.ExpirationDate.Value.ToString("dd.MM.yy")
            : "No expiration";
    }

    private static string FormatIv(decimal? value)
    {
        return value.HasValue ? $"{value.Value:0.##}%" : "-";
    }
}

<style>
    .price-chain {
        display: inline-flex;
        gap: 4px;
        align-items: center;
        white-space: nowrap;
    }

    .price-bid {
        color: #2e7d32;
    }

    .price-ask {
        color: #c62828;
    }

    .price-mark {
        color: rgba(255, 255, 255, 0.9);
    }

    .price-diff {
        color: var(--mud-palette-text-disabled, rgba(0, 0, 0, 0.45));
        margin-left: 2px;
    }

    .price-sep {
        color: var(--mud-palette-text-disabled, rgba(0, 0, 0, 0.38));
    }

    .temp-pnl-percent {
        display: block;
        margin-top: 2px;
        line-height: 1.1;
    }
    .mobile-temp-pnl {
        min-width: 100px;
    }

    .mobile-leg-card {
        background-color: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        padding: 12px;
    }

    .mobile-leg-card .price-chain {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
    }

    .leg-mobile-cell {
        display: none;
        padding: 0;
    }

    @@media (max-width: 960px) {
        .leg-table thead,
        .leg-table th {
            display: none;
        }

        .leg-table tr {
            display: block;
        }

        .leg-table td {
            display: none;
        }

        .leg-table td.leg-mobile-cell {
            display: table-cell;
        }

        .leg-mobile-cell .mud-paper-root {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leg-table .leg-desktop {
            display: none;
        }
    }

    @@media (min-width: 961px) {
        .leg-mobile-cell {
            display: none;
        }

        .leg-table tr {
            display: table-row;
        }

        .leg-table td.leg-mobile-cell {
            display: none;
        }
    }
</style>

