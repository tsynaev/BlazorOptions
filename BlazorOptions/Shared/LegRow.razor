@using System.Linq
@using BlazorOptions.ViewModels
@implements IDisposable

<MudTd DataLabel="Include">
    <MudCheckBox T="bool"
                 Value="@ViewModel.Leg.IsIncluded"
                 ValueChanged="ViewModel.UpdateLegIncludedAsync" />
</MudTd>
<MudTd DataLabel="Type">
    <MudSelect T="LegType" Value="@ViewModel.Leg.Type" ValueChanged="ViewModel.UpdateLegTypeAsync" Dense="true" Disabled="@ViewModel.Leg.IsReadOnly">
        @foreach (var type in ViewModel.LegTypes)
        {
            <MudSelectItem Value="@type">@type</MudSelectItem>
        }
    </MudSelect>
</MudTd>
<MudTd DataLabel="Strike">
    @{

        var strikeIsInList = ViewModel.Leg.Strike.HasValue 
                             && ViewModel.AvailableStrikes.Any(item => Math.Abs(item - ViewModel.Leg.Strike.Value) < 0.01m);
    }
    <MudSelect T="decimal?"
               Value="@ViewModel.Leg.Strike"
               ValueChanged="ViewModel.UpdateLegStrikeAsync"
               Dense="true"
               Variant="Variant.Outlined"
               Margin="Margin.Dense"
               Disabled="@(ViewModel.Leg.IsReadOnly || ViewModel.Leg.Type == LegType.Future || !ViewModel.Leg.ExpirationDate.HasValue)"
               Adornment="Adornment.End"
               AdornmentText="USDT">
        @if (ViewModel.Leg.Strike.HasValue && !strikeIsInList)
        {
            <MudSelectItem T="decimal?" Value="@ViewModel.Leg.Strike" Disabled="true">@FormatStrike(ViewModel.Leg.Strike)</MudSelectItem>
        }
        @if (!ViewModel.Leg.ExpirationDate.HasValue)
        {
            <MudSelectItem T="decimal?" Disabled="true">Select expiration first</MudSelectItem>
        }
        else if (ViewModel.AvailableStrikes.Count == 0)
        {
            <MudSelectItem T="decimal?" Disabled="true">No strikes for selected expiration</MudSelectItem>
        }
        else
        {
            @foreach (var strike in ViewModel.AvailableStrikes)
            {
                <MudSelectItem T="decimal?" Value="@strike">@FormatStrike(strike)</MudSelectItem>
            }
        }
    </MudSelect>
</MudTd>
<MudTd DataLabel="Expiration">

    <MudSelect T="DateTime?"
               Value="@ViewModel.Leg.ExpirationDate"
               ValueChanged="ViewModel.UpdateLegExpirationAsync"
               Dense="true"
               Variant="Variant.Outlined"
               Margin="Margin.Dense"
               Disabled="@(ViewModel.Leg.IsReadOnly || (ViewModel.AvailableExpirations.Count == 0))"
               Class="full-width">

        @if (ViewModel.AvailableExpirations.Count == 0)
        {
            <MudSelectItem T="DateTime?" Disabled="true">
                @(ViewModel.Leg.Type == LegType.Future ? "No expirations" : "No expirations available")
            </MudSelectItem>
        }
        else
        {
            @foreach (var expiration in ViewModel.AvailableExpirations)
            {
                <MudSelectItem T="DateTime?" Value="@expiration">@FormatExpiration(expiration)</MudSelectItem>
            }
        }
    </MudSelect>
</MudTd>
<MudTd DataLabel="Size">
    <MudNumericField T="decimal" Value="@ViewModel.Leg.Size" ValueChanged="ViewModel.UpdateLegSizeAsync" Variant="Variant.Outlined" Margin="Margin.Dense" Disabled="@ViewModel.Leg.IsReadOnly" />
</MudTd>
<MudTd DataLabel="Price">
    <MudStack Spacing="0">
        @{
            var placeholderPrice = ViewModel.PlaceholderPrice;
            var placeholder = placeholderPrice.HasValue ? placeholderPrice.Value.ToString("0.##") : null;
        }
        <MudNumericField T="decimal?"
                         Value="@ViewModel.Leg.Price"
                         ValueChanged="async value => await ViewModel.UpdateLegPriceAsync(value)"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Adornment="Adornment.End"
                         AdornmentText="USDT"
                         Placeholder="@placeholder"
                         Disabled="@ViewModel.Leg.IsReadOnly"
                         Class="price-input" />
        @{
            var markPrice = ViewModel.MarkPrice;
        }
        @if (ViewModel.IsLive && (ViewModel.Bid.HasValue || ViewModel.Ask.HasValue))
        {
            <MudText Typo="Typo.caption" Class="price-chain">
                <span class="price-bid">@FormatPrice(ViewModel.Bid)<span class="price-diff">@FormatDiff(ViewModel.Bid, markPrice)</span></span>
                <span class="price-sep">|</span>
                <span class="price-mark">@FormatPrice(markPrice)</span>
                <span class="price-sep">|</span>
                <span class="price-ask"><span class="price-diff">@FormatDiff(ViewModel.Ask, markPrice)</span> @FormatPrice(ViewModel.Ask)</span>
            </MudText>
        }
    </MudStack>
</MudTd>
<MudTd DataLabel="Temp P/L">
        @{
            var tempPnl = ViewModel.TempPnl;
            var tempPnlPercent = ViewModel.TempPnlPercent;
        }
    <MudStack Spacing="0">
        <MudText Typo="Typo.body2" Color="@(tempPnl >= 0 ? Color.Success : Color.Error)">
            @FormatPrice(tempPnl)
        </MudText>
        @if (tempPnlPercent.HasValue)
        {
            <MudText Typo="Typo.caption" Class="temp-pnl-percent">
                @($"{tempPnlPercent.Value:0.00}%")
            </MudText>
        }
    </MudStack>
</MudTd>
<MudTd DataLabel="IV" Class="iv-column">
        @{
            var chainIv = ViewModel.ChainIv;
        }
    <MudStack Spacing="0">
        <MudNumericField T="decimal?" Value="@ViewModel.Leg.ImpliedVolatility" ValueChanged="ViewModel.UpdateLegIvAsync" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="%" Disabled="@ViewModel.Leg.IsReadOnly" Class="iv-input" />
        @if (chainIv.HasValue)
        {
            <MudText Typo="Typo.caption" Class="iv-chain">Chain: @chainIv.Value.ToString("0.##")%</MudText>
        }
    </MudStack>
</MudTd>
<MudTd DataLabel="Actions" Style="text-align:right;">
    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="async () => await ViewModel.RemoveLegAsync()" />
</MudTd>

@code {
    [Parameter, EditorRequired] public LegViewModel ViewModel { get; set; } = default!;

    protected override void OnInitialized()
    {
        ViewModel.Changed += HandleViewModelChanged;
        ViewModel.Removed += HandleViewModelRemoved;
    }

    public void Dispose()
    {
        ViewModel.Changed -= HandleViewModelChanged;
        ViewModel.Removed -= HandleViewModelRemoved;
    }

    private void HandleViewModelChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private Task HandleViewModelRemoved()
    {
        return InvokeAsync(StateHasChanged);
    }

    private static string FormatPrice(decimal? price)
    {
        return price.HasValue ? price.Value.ToString("0.00") : "-";
    }

    private static string FormatDiff(decimal? price, decimal? mark)
    {
        if (!price.HasValue || !mark.HasValue)
        {
            return string.Empty;
        }

        var diff = price.Value - mark.Value;
        if (Math.Abs(diff) < 0.0001m)
        {
            return string.Empty;
        }

        var sign = diff > 0 ? "+" : string.Empty;
        return $"({sign}{diff:0.00})";
    }

    private static string FormatStrike(decimal? strike)
    {
        return strike.HasValue ? strike.Value.ToString("0.00") : string.Empty;
    }

    private static string FormatExpiration(DateTime? date)
    {
        return date.HasValue ? date.Value.ToString("yyyy-MM-dd") : string.Empty;
    }
}

<style>
    .price-chain {
        display: inline-flex;
        gap: 4px;
        align-items: center;
        white-space: nowrap;
    }

    .price-bid {
        color: #2e7d32;
    }

    .price-ask {
        color: #c62828;
    }

    .price-mark {
        color: rgba(255, 255, 255, 0.9);
    }

    .price-diff {
        color: var(--mud-palette-text-disabled, rgba(0, 0, 0, 0.45));
        margin-left: 2px;
    }

    .price-sep {
        color: var(--mud-palette-text-disabled, rgba(0, 0, 0, 0.38));
    }

    .temp-pnl-percent {
        display: block;
        margin-top: 2px;
        line-height: 1.1;
    }
</style>

