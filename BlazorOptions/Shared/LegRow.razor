@using BlazorOptions.ViewModels
@using BlazorOptions.Services
@implements IDisposable

<MudTd DataLabel="Include">
    <MudCheckBox T="bool"
                 Value="@Leg.IsIncluded"
                 ValueChanged="async checkedValue => await ViewModel.UpdateLegIncludedAsync(Leg, checkedValue)" />
</MudTd>
<MudTd DataLabel="Type">
    <MudSelect T="LegType" Value="@Leg.Type" ValueChanged="async type => await ViewModel.UpdateLegTypeAsync(Leg, type)" Dense="true" Disabled="@Leg.IsReadOnly">
        @foreach (var type in ViewModel.LegTypes)
        {
            <MudSelectItem Value="@type">@type</MudSelectItem>
        }
    </MudSelect>
</MudTd>
<MudTd DataLabel="Strike">
    <MudNumericField T="double?" Value="@Leg.Strike" ValueChanged="async value => await ViewModel.UpdateLegStrikeAsync(Leg, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="USDT" Disabled="@Leg.IsReadOnly" />
</MudTd>
<MudTd DataLabel="Expiration">
    <MudDatePicker Date="Leg.ExpirationDate"
                   DateChanged="date => ViewModel.UpdateLegExpirationAsync(Leg, date)"
                   DateFormat="yyyy-MM-dd"
                   Class="full-width"
                   Disabled="@Leg.IsReadOnly" />
</MudTd>
<MudTd DataLabel="Size">
    <MudNumericField T="double" Value="@Leg.Size" ValueChanged="async value => await ViewModel.UpdateLegSizeAsync(Leg, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Disabled="@Leg.IsReadOnly" />
</MudTd>
<MudTd DataLabel="Price">
    <MudStack Spacing="0">
        @{
            var placeholderPrice = Leg.Price.HasValue ? null : ViewModel.GetLegMarketPrice(Leg);
            var placeholder = placeholderPrice.HasValue ? placeholderPrice.Value.ToString("0.##") : null;
        }
        <MudNumericField T="double?"
                         Value="@Leg.Price"
                         ValueChanged="async value => await ViewModel.UpdateLegPriceAsync(Leg, value)"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Adornment="Adornment.End"
                         AdornmentText="USDT"
                         Placeholder="@placeholder"
                         Disabled="@Leg.IsReadOnly"
                         Class="price-input" />
        @{
            var bidAsk = ViewModel.GetLegBidAsk(Leg);
            var markPrice = ViewModel.GetLegMarkPrice(Leg);
        }
        @if (bidAsk.Bid.HasValue || bidAsk.Ask.HasValue)
        {
            <MudText Typo="Typo.caption" Class="price-chain">
                <span class="price-bid">@FormatPrice(bidAsk.Bid)<span class="price-diff">@FormatDiff(bidAsk.Bid, markPrice)</span></span>
                <span class="price-sep">|</span>
                <span class="price-mark">@FormatPrice(markPrice)</span>
                <span class="price-sep">|</span>
                <span class="price-ask"><span class="price-diff">@FormatDiff(bidAsk.Ask, markPrice)</span> @FormatPrice(bidAsk.Ask)</span>
            </MudText>
        }
    </MudStack>
</MudTd>
<MudTd DataLabel="Temp P/L">
    @{
        var tempPnl = ViewModel.GetLegTemporaryPnl(Leg);
    }
    <MudText Typo="Typo.body2" Color="@(tempPnl >= 0 ? Color.Success : Color.Error)">
        @tempPnl.ToString("0.##")
    </MudText>
</MudTd>
<MudTd DataLabel="IV" Class="iv-column">
    @{
        var chainIv = ViewModel.GetLegMarkIv(Leg);
    }
    <MudStack Spacing="0">
        <MudNumericField T="double?" Value="@Leg.ImpliedVolatility" ValueChanged="async value => await ViewModel.UpdateLegIvAsync(Leg, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="%" Disabled="@Leg.IsReadOnly" Class="iv-input" />
        @if (chainIv.HasValue)
        {
            <MudText Typo="Typo.caption" Class="iv-chain">Chain: @chainIv.Value.ToString("0.##")%</MudText>
        }
    </MudStack>
</MudTd>
<MudTd DataLabel="Actions" Style="text-align:right;">
    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="async () => await ViewModel.RemoveLegAsync(Leg)" />
</MudTd>

@code {
    [Parameter, EditorRequired] public LegModel Leg { get; set; } = default!;
    [Parameter, EditorRequired] public LegsCollectionViewModel ViewModel { get; set; } = default!;

    private string? _symbol;

    protected override void OnInitialized()
    {
        ViewModel.LegTickerUpdated += HandleLegTickerUpdated;
        ViewModel.ActivePositionUpdated += HandleActivePositionUpdated;
    }

    protected override void OnParametersSet()
    {
        _symbol = ViewModel.GetLegSymbol(Leg);
    }

    private void HandleLegTickerUpdated(OptionChainTicker ticker)
    {
        if (ticker is null || string.IsNullOrWhiteSpace(ticker.Symbol))
        {
            return;
        }

        if (string.Equals(ticker.Symbol, _symbol, StringComparison.OrdinalIgnoreCase))
        {
           _ = InvokeAsync(StateHasChanged);
        }
    }

    private void HandleActivePositionUpdated(BybitPosition position)
    {
        if (position is null || string.IsNullOrWhiteSpace(position.Symbol))
        {
            return;
        }

        if (string.Equals(position.Symbol, _symbol, StringComparison.OrdinalIgnoreCase))
        {
            _ = InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        ViewModel.LegTickerUpdated -= HandleLegTickerUpdated;
        ViewModel.ActivePositionUpdated -= HandleActivePositionUpdated;
    }

    private static string FormatPrice(double? price)
    {
        return price.HasValue ? price.Value.ToString("0.##") : "-";
    }

    private static string FormatDiff(double? price, double? mark)
    {
        if (!price.HasValue || !mark.HasValue)
        {
            return string.Empty;
        }

        var diff = price.Value - mark.Value;
        if (Math.Abs(diff) < 0.0001)
        {
            return string.Empty;
        }

        var sign = diff > 0 ? "+" : string.Empty;
        return $"({sign}{diff:0.##})";
    }
}

<style>
    .price-chain {
        display: inline-flex;
        gap: 4px;
        align-items: center;
        white-space: nowrap;
    }

    .price-bid {
        color: #2e7d32;
    }

    .price-ask {
        color: #c62828;
    }

    .price-mark {
        color: rgba(255, 255, 255, 0.9);
    }

    .price-diff {
        color: var(--mud-palette-text-disabled, rgba(0, 0, 0, 0.45));
        margin-left: 2px;
    }

    .price-sep {
        color: var(--mud-palette-text-disabled, rgba(0, 0, 0, 0.38));
    }
</style>

