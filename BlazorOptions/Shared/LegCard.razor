@using System.Globalization
@using BlazorOptions.ViewModels
@using MudBlazor
@inject IDialogService DialogService
@inject INavigationService NavigationService

<MudPaper Elevation="1" Class="@GetCardClass()">
    <MudStack Spacing="1">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudCheckBox T="bool"
                         Value="@ViewModel.Leg.IsIncluded"
                         ValueChanged="ViewModel.UpdateLegIncludedAsync"
                         Color="Color.Primary"
                         Class="leg-card-include" />
            <MudText Typo="Typo.subtitle2">@BuildLegSummary()</MudText>
            <MudSpacer />
            <MudChip T="string"
                     Variant="Variant.Outlined"
                     Size="Size.Small"
                     Color="@ResolveStatusColor(ViewModel.Leg.Status)"
                     Class="leg-status-chip">
                @ResolveStatusLabel(ViewModel.Leg.Status)
            </MudChip>
            @if (ViewModel.Leg.Status == LegStatus.Missing)
            {
                <MudTooltip Text="@ViewModel.StatusMessage">
                    <MudIcon Icon="@Icons.Material.Filled.ReportProblem"
                             Color="Color.Warning"
                             Size="Size.Small"
                             Class="leg-card-warning" />
                </MudTooltip>
            }
        </MudStack>
        <MudText Typo="Typo.overline" Class="leg-card-subtitle">@BuildLegSubtitle()</MudText>
        <table class="leg-price-table">
            <thead>
                <tr class="leg-price-header-row">
                    <th></th>
                    <th>Price</th>
                    <th>IV</th>
                    <th>Volume</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Entry</td>
                    <td>@FormatPrice(GetDisplayPrice())</td>
                    <td>@(ViewModel.Leg.Type == LegType.Future ? "-" : FormatIv(ViewModel.Leg.ImpliedVolatility))</td>
                    <td>@FormatPrice(CalculateValue(GetDisplayPrice(), ViewModel.Leg.Size))</td>
                </tr>
                <tr>
                    <td>Mark</td>
                    <td>@FormatPrice(ViewModel.MarkPrice)</td>
                    <td>@(ViewModel.Leg.Type == LegType.Future ? "-" : FormatIv(ViewModel.ChainIv ?? ViewModel.Leg.ImpliedVolatility))</td>
                    <td>@FormatPrice(CalculateValue(ViewModel.MarkPrice, ViewModel.Leg.Size))</td>
                </tr>
            </tbody>
        </table>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudText Typo="Typo.caption" Color="@(ViewModel.PnL >= 0 ? Color.Success : Color.Error)">
                P/L: @FormatPrice(ViewModel.PnL)
            </MudText>
            @if (ViewModel.PnLPercent.HasValue)
            {
                <MudText Typo="Typo.caption">
                    (@($"{ViewModel.PnLPercent.Value:0.00}%"))
                </MudText>
            }
            @if (ViewModel.IsLive && (ViewModel.Bid.HasValue || ViewModel.Ask.HasValue))
            {
                <MudText Typo="Typo.caption">
                    Bid: @FormatPrice(ViewModel.Bid) | Ask: @FormatPrice(ViewModel.Ask)
                </MudText>
            }
        </MudStack>
        @if (ViewModel.Leg.Type != LegType.Future)
        {
            <div class="leg-mini-divider"><span>Greeks</span></div>
            <MudText Typo="Typo.caption" Class="leg-card-greeks">
                Δ @FormatGreek(ViewModel.Delta) · Γ @FormatGreek(ViewModel.Gamma) · ν @FormatGreek(ViewModel.Vega) · Θ @FormatGreek(ViewModel.Theta)
            </MudText>
        }
        @if (ViewModel.LinkedOrders.Count > 0)
        {
            <div class="leg-mini-divider"><span>Orders</span></div>
            <MudStack Spacing="1" Class="leg-orders-list">
                @foreach (var order in ViewModel.LinkedOrders)
                {
                    <MudChip T="string"
                             Variant="@(order.IsActivated ? Variant.Filled : Variant.Outlined)"
                             Size="Size.Small" Label="true"
                             Color="@ResolvePnlColor(order.ExpectedPnl)"
                             OnClick="@(() => ToggleLinkedOrder(order.OrderId))"
                             Class="leg-linked-order-chip">
                        <span class="linked-order-text">@BuildLinkedOrderText(order)</span>
                    </MudChip>
                }
            </MudStack>
        }
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="leg-card-actions">
            <MudLink Typo="Typo.caption"
                     Color="Color.Info"
                     Underline="Underline.Hover"
                     OnClick="OpenSymbolOrdersDialogAsync"
                     Class="leg-symbol-link">
                @GetSymbolLabel()
            </MudLink>
            <MudSpacer />
            @if (!ViewModel.Leg.IsReadOnly)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Color="Color.Primary"
                               Size="Size.Small"
                               Class="leg-card-icon"
                               OnClick="OpenEditDialogAsync" />
            }
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           Color="Color.Error"
                           Size="Size.Small"
                           Class="leg-card-icon"
                           OnClick="async () => await ViewModel.RemoveLegAsync()" />
        </MudStack>
    </MudStack>
</MudPaper>

@code {
    [Parameter, EditorRequired] public LegViewModel ViewModel { get; set; } = default!;

    private static string FormatPrice(decimal? price)
    {
        return price.HasValue ? price.Value.ToString("0.00") : "-";
    }

    private static decimal? CalculateValue(decimal? price, decimal size)
    {
        return price.HasValue ? price.Value * size : null;
    }

    private decimal? GetDisplayPrice()
    {
        if (ViewModel.Leg.Type == LegType.Future && !ViewModel.Leg.Price.HasValue)
        {
            return ViewModel.CurrentPrice ?? ViewModel.PlaceholderPrice;
        }

        return ViewModel.Leg.Price ?? ViewModel.PlaceholderPrice;
    }

    private async Task OpenEditDialogAsync()
    {
        var parameters = new DialogParameters
        {
            { nameof(LegEditDialog.ViewModel), ViewModel }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<LegEditDialog>("Edit leg", parameters, options);
    }

    private string BuildLegSummary()
    {
        var direction = ViewModel.Leg.Size >= 0 ? "Buy" : "Sell";
        var typeLabel = ViewModel.Leg.Type.ToString().ToUpperInvariant();
        var size = Math.Abs(ViewModel.Leg.Size);
        if (ViewModel.Leg.Type == LegType.Future)
        {
            return $"{direction} {size:0.##} {typeLabel}";
        }

        var strike = ViewModel.Leg.Strike.HasValue
            ? Math.Round(ViewModel.Leg.Strike.Value).ToString("0", CultureInfo.InvariantCulture)
            : "ATM";
        return $"{direction} {size:0.##} {typeLabel} {strike}";
    }

    private string BuildLegSubtitle()
    {
        return ViewModel.Leg.ExpirationDate.HasValue
            ? ViewModel.Leg.ExpirationDate.Value.ToString("dd.MM.yy")
            : ViewModel.Leg.Type == LegType.Future ? "Perpetual" : "No expiration";
    }

    private string GetSymbolLabel()
    {
        var symbol = ViewModel.Leg.Symbol;
        return string.IsNullOrWhiteSpace(symbol) ? "No symbol" : symbol.ToUpperInvariant();
    }

    private static string FormatIv(decimal? value)
    {
        return value.HasValue ? $"{value.Value:0.##}%" : "-";
    }

    private static string FormatGreek(decimal? value)
    {
        return value.HasValue ? value.Value.ToString("0.###", CultureInfo.InvariantCulture) : "-";
    }

    private string BuildLinkedOrderPrefix(LegLinkedOrderModel order)
    {
        var sideSign = string.Equals(order.Side, "Sell", StringComparison.OrdinalIgnoreCase) ? "-" : "+";
        var kind = $"{order.OrderKind} ".TrimStart();
        var type = ViewModel.Leg.Type switch
        {
            LegType.Call => "C",
            LegType.Put => "P",
            _ => "F"
        };

        if (ViewModel.Leg.Type == LegType.Future)
        {
            return $"{kind}{sideSign}{order.Quantity:0.####} {type}";
        }

        var strike = ViewModel.Leg.Strike.HasValue
            ? Math.Round(ViewModel.Leg.Strike.Value).ToString("0", CultureInfo.InvariantCulture)
            : "ATM";
        return $"{kind}{sideSign}{order.Quantity:0.####} {type} {strike}";
    }

    private void ToggleLinkedOrder(string orderId)
    {
        ViewModel.ToggleLinkedOrderActivation(orderId);
    }

    private async Task OpenSymbolOrdersDialogAsync()
    {
        var symbol = ViewModel.Leg.Symbol?.Trim();
        if (string.IsNullOrWhiteSpace(symbol))
        {
            return;
        }

        await NavigationService.NavigateToAsync<TradingSymbolDialogViewModel>(
            vm => vm.LoadAsync(symbol, null, null));
    }

    private string BuildLinkedOrderText(LegLinkedOrderModel order)
    {
        var text = $"{BuildLinkedOrderPrefix(order)} @ {FormatPrice(order.Price)}";
        return order.NewAverageEntryPrice.HasValue
            ? $"{text} | Avg: {FormatPrice(order.NewAverageEntryPrice)}"
            : $"{text} | P/L: {FormatPrice(order.ExpectedPnl)}";
    }

    private string GetCardClass()
    {
        return ViewModel.Leg.Status switch
        {
            LegStatus.Order => "leg-card leg-card-order",
            LegStatus.Active => "leg-card leg-card-active",
            LegStatus.Missing => "leg-card leg-card-missing",
            _ => "leg-card leg-card-new"
        };
    }

    private static string ResolveStatusLabel(LegStatus status)
    {
        return status switch
        {
            LegStatus.New => "New",
            LegStatus.Order => "Order",
            LegStatus.Active => "Active",
            LegStatus.Missing => "Missing",
            _ => "New"
        };
    }

    private static Color ResolveStatusColor(LegStatus status)
    {
        return status switch
        {
            LegStatus.Order => Color.Warning,
            LegStatus.Active => Color.Success,
            LegStatus.Missing => Color.Error,
            _ => Color.Default
        };
    }

    private static Color ResolvePnlColor(decimal? pnl)
    {
        if (!pnl.HasValue)
        {
            return Color.Default;
        }

        return pnl.Value >= 0 ? Color.Success : Color.Error;
    }
}

<style>
    .leg-card {
        background-color: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        padding: 12px;
        width: 100%;
        min-height: 150px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .leg-card-new {
        background-color: rgba(255, 255, 255, 0.02);
    }

    .leg-card-active {
        background-color: rgba(32, 130, 64, 0.18);
        border-color: rgba(46, 204, 113, 0.35);
    }

    .leg-card-order {
        background-color: rgba(184, 134, 11, 0.14);
        border-color: rgba(255, 193, 7, 0.45);
    }

    .leg-card-missing {
        background-color: rgba(150, 30, 30, 0.2);
        border-color: rgba(231, 76, 60, 0.4);
    }

    .leg-card-include {
        margin: 0;
        padding: 0;
    }

    .leg-card-include .mud-icon-button {
        margin: 0;
        padding: 0;
    }

    .leg-card-greeks {
        opacity: 0.8;
    }

    .leg-mini-divider {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.58rem;
        line-height: 1;
        opacity: 0.32;
        letter-spacing: 0.03em;
        margin-top: 2px;
        margin-bottom: 1px;
    }

    .leg-mini-divider::after {
        content: "";
        flex: 1;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        transform: translateY(1px);
    }

    .leg-card-icon .mud-icon-button {
        padding: 4px;
    }

    .leg-card-warning {
        margin-top: 1px;
    }

    .leg-status-chip {
        height: 20px;
        padding: 0 6px;
    }

    .leg-card-actions {
        margin-top: 2px;
    }
    .leg-symbol-link {
        max-width: calc(100% - 36px);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.72rem;
        letter-spacing: 0.02em;
    }
    .leg-price-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        font-size: 0.75rem;
        line-height: 1.2;
    }
    .leg-price-table th,
    .leg-price-table td {
        padding: 1px 8px 1px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .leg-price-table th {
        font-size: 0.58rem;
        line-height: 1;
        font-weight: 500;
        letter-spacing: 0.03em;
        opacity: 0.32;
        color: rgba(255, 255, 255, 0.75);
        text-align: right;
        padding-bottom: 3px;
    }
    .leg-price-header-row th:first-child {
        width: 34px;
        padding-right: 2px;
        text-align: left;
    }
    .leg-price-table td:first-child {
        width: 34px;
        padding-right: 2px;
        color: rgba(255, 255, 255, 0.8);
    }
    .leg-price-table td:nth-child(2),
    .leg-price-table td:nth-child(3),
    .leg-price-table td:nth-child(4) {
        text-align: right;
    }

  
    .leg-orders-list {
        max-height: none;
        overflow-y: visible;
        overflow-x: hidden;
        padding-right: 0;
    }

    .leg-linked-order-chip {
        height: auto;
        justify-content: flex-start;
    }

    .linked-order-text {
        display: block;
        max-width: 100%;
        white-space: normal;
        overflow-wrap: anywhere;
        line-height: 1.2;
    }
</style>




