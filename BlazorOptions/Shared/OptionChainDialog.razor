@using BlazorOptions.Services
@implements IDisposable
@inject OptionChainDialogViewModel ViewModel

<MudDialog Class="option-chain-dialog">
    <DialogContent>
        <MudStack Spacing="2">
            <MudStack Spacing="1">
                <MudText Typo="Typo.subtitle2">Expiration</MudText>
                <MudTabs Rounded="true" Elevation="0" Color="Color.Primary" ActivePanelIndex="@SelectedExpirationIndex" ActivePanelIndexChanged="OnExpirationTabChanged">
                    @for (var index = 0; index < ViewModel.AvailableExpirations.Count; index++)
                    {
                        var expiration = ViewModel.AvailableExpirations[index];
                        <MudTabPanel Text="@FormatExpirationTab(expiration)" />
                    }
                </MudTabs>
            </MudStack>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudSpacer />
                @if (ViewModel.IsRefreshing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <MudText Typo="Typo.caption">Updating chain...</MudText>
                }
            </MudStack>

            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudPaper Class="pa-2 strikes-panel">
                        <MudText Typo="Typo.subtitle2">Strikes</MudText>
                        <MudTable Items="@ViewModel.AvailableStrikes" Dense="true" Hover="true" Bordered="true" FixedHeader="true" Height="500px" RowClassFunc="StrikeRowClass">
                            <HeaderContent>
                                <MudTh>Strike</MudTh>
                                <MudTh>IV%</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Strike">@context.ToString("0")</MudTd>
                                <MudTd DataLabel="IV%">@FormatStrikeIv(context)</MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudStack Row="true" Spacing="1">
                                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary" OnClick="() => ViewModel.AddLeg(context, OptionLegType.Call)">C</MudButton>
                                        <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Secondary" OnClick="() => ViewModel.AddLeg(context, OptionLegType.Put)">P</MudButton>
                                    </MudStack>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="8">
                    <MudPaper Class="pa-2">
                        <MudTable Items="@ViewModel.Legs" Dense="true" Hover="true" Bordered="true">
                            <HeaderContent>
                                <MudTh>Contract</MudTh>
                                <MudTh>Qty</MudTh>
                                <MudTh>Input</MudTh>
                                <MudTh>Delta</MudTh>
                                <MudTh>Gamma</MudTh>
                                <MudTh>Vega</MudTh>
                                <MudTh>Theta</MudTh>
                                <MudTh></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                @{
                                    var ticker = ViewModel.GetTickerForLeg(context);
                                }
                                <MudTd DataLabel="Contract">
                                    <MudText Typo="Typo.caption" Class="contract-symbol">@ViewModel.GetContractSymbol(context)</MudText>
                                    <MudText Typo="Typo.caption" Class="contract-description">@ViewModel.GetContractDescription(context)</MudText>
                                </MudTd>
                                <MudTd DataLabel="Qty">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle" Size="Size.Small" OnClick="() => ViewModel.AdjustLegSize(context, -1)" />
                                        <MudNumericField T="double"
                                                         Value="@context.Size"
                                                         ValueChanged="value => ViewModel.SetLegSize(context, value)"
                                                         Margin="Margin.Dense"
                                                         Variant="Variant.Outlined"
                                                         HideSpinButtons="true"
                                                         Class="qty-field" />
                                        <MudIconButton Icon="@Icons.Material.Filled.AddCircle" Size="Size.Small" OnClick="() => ViewModel.AdjustLegSize(context, 1)" />
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Input">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudNumericField T="double"
                                                         Value="@ViewModel.GetLegInputValue(context)"
                                                         ValueChanged="value => ViewModel.SetLegInputValue(context, value)"
                                                         Margin="Margin.Dense"
                                                         Variant="Variant.Outlined"
                                                         Adornment="Adornment.End"
                                                         AdornmentText="@(ViewModel.IsLegIvMode(context) ? "%" : "USDT")"
                                                         HideSpinButtons="true"
                                                         Class="input-field" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Autorenew" Size="Size.Small" OnClick="() => ViewModel.ToggleLegInputMode(context)" />
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Delta">@FormatMetric(ticker?.Delta)</MudTd>
                                <MudTd DataLabel="Gamma">@FormatMetric(ticker?.Gamma)</MudTd>
                                <MudTd DataLabel="Vega">@FormatMetric(ticker?.Vega)</MudTd>
                                <MudTd DataLabel="Theta">@FormatMetric(ticker?.Theta)</MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Error" OnClick="() => ViewModel.RemoveLeg(context)" />
                                </MudTd>
                            </RowTemplate>
                            <FooterContent>
                                <MudTd DataLabel="Contract">
                                    <MudText Typo="Typo.subtitle2">Totals</MudText>
                                </MudTd>
                                <MudTd DataLabel="Qty">@ViewModel.GetTotalQuantity().ToString("0.##")</MudTd>
                                <MudTd DataLabel="Input">
                                    <MudText Typo="Typo.caption">Premium: @ViewModel.GetTotalPremium().ToString("0.##")</MudText>
                                    <MudText Typo="Typo.caption">IV Avg: @ViewModel.GetAverageImpliedVolatility().ToString("0.##")%</MudText>
                                </MudTd>
                                <MudTd DataLabel="Delta">@ViewModel.GetTotalGreek(t => t.Delta).ToString("0.###")</MudTd>
                                <MudTd DataLabel="Gamma">@ViewModel.GetTotalGreek(t => t.Gamma).ToString("0.###")</MudTd>
                                <MudTd DataLabel="Vega">@ViewModel.GetTotalGreek(t => t.Vega).ToString("0.###")</MudTd>
                                <MudTd DataLabel="Theta">@ViewModel.GetTotalGreek(t => t.Theta).ToString("0.###")</MudTd>
                                <MudTd></MudTd>
                            </FooterContent>
                        </MudTable>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="Submit">OK</MudButton>
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="Cancel">Cancel</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance Dialog { get; set; } = default!;
    [Parameter] public PositionModel? Position { get; set; }
    [Parameter] public double? UnderlyingPrice { get; set; }
    private int SelectedExpirationIndex { get; set; }

    protected override async Task OnInitializedAsync()
    {
        ViewModel.OnChange += HandleChange;
        await ViewModel.InitializeAsync(Position, UnderlyingPrice);
        UpdateSelectedExpirationIndex();
    }

    private void HandleChange()
    {
        UpdateSelectedExpirationIndex();
        InvokeAsync(StateHasChanged);
    }

    private void Submit()
    {
        Dialog.Close(DialogResult.Ok(ViewModel.Legs.ToList()));
    }

    private void Cancel()
    {
        Dialog.Cancel();
    }

    private string FormatExpirationTab(DateTime value)
    {
        return value.ToString("dd MMM yyyy").ToUpperInvariant();
    }

    private void OnExpirationTabChanged(int index)
    {
        if (index < 0 || index >= ViewModel.AvailableExpirations.Count)
        {
            return;
        }

        SelectedExpirationIndex = index;
        ViewModel.SetSelectedExpiration(ViewModel.AvailableExpirations[index]);
    }

    private void UpdateSelectedExpirationIndex()
    {
        if (ViewModel.SelectedExpiration is null)
        {
            SelectedExpirationIndex = 0;
            return;
        }

        var index = ViewModel.AvailableExpirations
            .Select((date, position) => (date, position))
            .FirstOrDefault(item => item.date.Date == ViewModel.SelectedExpiration.Value.Date);
        SelectedExpirationIndex = index == default ? 0 : index.position;
    }

    private static string FormatMetric(double? value)
    {
        return value?.ToString("0.###") ?? "0";
    }

    private string FormatStrikeIv(double strike)
    {
        var iv = ViewModel.GetStrikeImpliedVolatility(strike);
        return iv?.ToString("0.##") ?? "0";
    }

    private string StrikeRowClass(double strike, int index)
    {
        return ViewModel.IsAtmStrike(strike) ? "atm-strike-row" : string.Empty;
    }

    public void Dispose()
    {
        ViewModel.OnChange -= HandleChange;
        ViewModel.Dispose();
    }
}

<style>
    .atm-strike-row > td {
        background-color: rgba(33, 150, 243, 0.12);
        font-weight: 600;
    }

    .contract-symbol {
        color: var(--mud-palette-text-secondary);
        font-size: 0.72rem;
        line-height: 1.1;
    }

    .contract-description {
        color: var(--mud-palette-text-secondary);
        font-size: 0.68rem;
        line-height: 1.1;
    }

    .qty-field,
    .input-field {
        min-width: 110px;
    }
</style>
