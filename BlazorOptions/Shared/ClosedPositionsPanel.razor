@using BlazorOptions.ViewModels
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@using System.Collections.ObjectModel
@using System.Linq

@if (ViewModel is not null)
{
    <MudCard Class="closed-positions-card">
        <MudCardHeader>
            <MudStack Spacing="1" Class="flex-grow-1">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudCheckBox T="bool"
                                 @bind-Value="@ViewModel.Model.Include"
                                 />
                    <MudText Typo="Typo.h6">Closed positions</MudText>
                    <MudText Typo="Typo.caption" Class="closed-positions-summary">
                        Net: @ViewModel.Model.TotalNet.ToString("0.##")
                    </MudText>
                    <MudText Typo="Typo.caption" Class="closed-positions-summary">
                        PnL: @ViewModel.Model.TotalClosePnl.ToString("0.##") | Fee: @ViewModel.Model.TotalFee.ToString("0.##")
                    </MudText>
                    <MudSpacer />
                </MudStack>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudTextField T="string"
                                  @bind-Value="ViewModel.AddSymbolInput"
                                  Label="Add symbols"
                                  Placeholder="Paste symbols, one per line"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Immediate="true"
                                  OnKeyDown="HandleAddSymbolKeyDown"
                                  Lines="4"
                                  Class="closed-positions-symbol-input" />
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="async () => await ViewModel.AddSymbolAsync()">
                        Add
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               OnClick="OpenTradesDialogAsync">
                        Select trades
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudCardHeader>
        <MudCardContent>
            <MudTable Items="ViewModel.ClosedPositions"
                      Dense="true"
                      Hover="true"
                      Class="closed-positions-table">
                <HeaderContent>
                    <MudTh>Since</MudTh>
                    <MudTh>Symbol</MudTh>
                    <MudTh>Size</MudTh>
                    <MudTh>Avg. Entry Price</MudTh>
                    <MudTh>Avg. Close Price</MudTh>
                    <MudTh>Close P&amp;L</MudTh>
                    <MudTh>Fee</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <ClosedPositionRow ViewModel="context" OnOpenSymbolDialog="OpenSymbolDialogAsync" @key="context.Model.Id" />
                </RowTemplate>
            </MudTable>
        </MudCardContent>
    </MudCard>
}

@code {
    [Parameter, EditorRequired] public ClosedPositionsViewModel ViewModel { get; set; } = default!;

    [Inject] private INavigationService NavigationService { get; set; } = default!;

    private ClosedPositionsViewModel? _lastViewModel;

    protected override void OnParametersSet()
    {
        if (ViewModel is null)
        {
            return;
        }

        if (!ReferenceEquals(_lastViewModel, ViewModel))
        {
            _lastViewModel = ViewModel;
            _ = ViewModel.InitializeAsync();
        }
    }

    protected override void OnInitialized()
    {
        ViewModel.PropertyChanged += (_, _) => InvokeAsync(StateHasChanged);
        ViewModel.ClosedPositions.CollectionChanged += (_, _) => InvokeAsync(StateHasChanged);
    }

    private Task HandleAddSymbolKeyDown(KeyboardEventArgs args)
    {
        return ViewModel.OnAddSymbolKeyDown(args.Key, args.CtrlKey, args.MetaKey);
    }


    private async Task OpenSymbolDialogAsync(string symbol, DateTime? sinceDate)
    {
        if (string.IsNullOrWhiteSpace(symbol))
        {
            return;
        }

        await NavigationService.NavigateToAsync<TradingSymbolDialogViewModel>(viewModel =>
            viewModel.LoadAsync(symbol, string.Empty, sinceDate));
    }

    private async Task OpenTradesDialogAsync()
    {
        var existingSymbols = ViewModel.ClosedPositions
            .Select(item => item.Model.Symbol)
            .Where(symbol => !string.IsNullOrWhiteSpace(symbol))
            .ToList();

        var baseAsset = ViewModel.BaseAsset;
        var dialogViewModel = await NavigationService.NavigateToAsync<TradingHistorySelectionDialogViewModel>(
            viewModel => viewModel.InitializeAsync(existingSymbols, baseAsset));

        var selectedSymbols = await dialogViewModel.WaitForSelectionAsync();
        if (selectedSymbols is null || selectedSymbols.Count == 0)
        {
            return;
        }

        ViewModel.SetAddSymbolInput(selectedSymbols);
        await ViewModel.AddSymbolAsync();
    }
}

<style>
    .closed-positions-card .mud-card-header-content {
        width: 100%;
    }

    .closed-positions-summary {
        opacity: 0.8;
    }

    .closed-positions-symbol-input {
        min-width: 220px;
    }

    .closed-positions-since-date {
        width: 120px;
        min-width: 120px;
    }

    .closed-positions-since-time {
        width: 110px;
        min-width: 110px;
    }
</style>
