@implements IAsyncDisposable
@inject IJSRuntime JS
@using BlazorOptions.ViewModels

<div class="dvol-chart-host">
    <div class="dvol-chart" @ref="_chartRef"></div>
</div>

@code {
    [Parameter] public IReadOnlyList<string> Labels { get; set; } = Array.Empty<string>();
    [Parameter] public IReadOnlyList<DvolCandlePoint> Candles { get; set; } = Array.Empty<DvolCandlePoint>();
    [Parameter] public double? AverageValue { get; set; }
    [Parameter] public bool IsDarkTheme { get; set; } = true;

    private ElementReference _chartRef;
    private IJSObjectReference? _module;
    private bool _initialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/dvolChart.js");
            _initialized = true;
        }

        if (_initialized && _module is not null)
        {
            var candleValues = Candles
                .Select(candle => new[] { candle.Open, candle.Close, candle.Low, candle.High })
                .ToArray();
            await _module.InvokeVoidAsync("render", _chartRef, Labels, candleValues, AverageValue, IsDarkTheme);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("dispose", _chartRef);
                await _module.DisposeAsync();
            }
            catch
            {
                // Ignore JS disposal failures during teardown.
            }
        }
    }
}

<style>
    .dvol-chart-host {
        width: 100%;
    }

    .dvol-chart {
        width: 100%;
        height: 300px;
    }
</style>
