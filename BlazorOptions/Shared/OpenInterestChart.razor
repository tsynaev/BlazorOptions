@using BlazorOptions.ViewModels
@implements IAsyncDisposable

<div class="chart-host @Class" style="@($"height:{Height};{Style}")">
    <div class="echart" @ref="_chartRef"></div>
</div>

@code {
    [Parameter] public OpenInterestChartOptions? Config { get; set; }
    [Parameter] public string Height { get; set; } = "520px";
    [Parameter] public string? Class { get; set; }
    [Parameter] public string? Style { get; set; }
    [Inject] private IJSRuntime JS { get; set; } = default!;

    private ElementReference _chartRef;
    private bool _needsRender;
    private IJSObjectReference? _module;

    protected override void OnParametersSet()
    {
        _needsRender = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_needsRender || Config is null)
        {
            return;
        }

        _needsRender = false;
        _module ??= await JS.InvokeAsync<IJSObjectReference>("import", "./js/openInterestChart.js");
        await _module.InvokeVoidAsync("render", _chartRef, Config);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_module is not null)
            {
                await _module.InvokeVoidAsync("dispose", _chartRef);
                await _module.DisposeAsync();
            }
        }
        catch
        {
        }
    }
}

<style>
    .chart-host {
        width: 100%;
    }

    .chart-host .echart {
        width: 100%;
        height: 100%;
    }
</style>
