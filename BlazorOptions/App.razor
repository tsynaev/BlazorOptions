@using MudBlazor
@inject IJSRuntime JsRuntime
@implements IAsyncDisposable

<MudThemeProvider @ref="_mudThemeProvider"
                  Theme="@BybitTheme"
                  IsDarkMode="@_isDarkMode"
                  IsDarkModeChanged="HandleIsDarkModeChanged" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<CascadingValue Value="_isDarkMode">
    <Router AppAssembly="@typeof(App).Assembly">
        <Found Context="routeData">
            <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
            <FocusOnNavigate RouteData="@routeData" Selector="h1" />
        </Found>
        <NotFound>
            <PageTitle>Not found</PageTitle>
            <LayoutView Layout="@typeof(MainLayout)">
                <p role="alert">Sorry, there's nothing at this address.</p>
            </LayoutView>
        </NotFound>
    </Router>
</CascadingValue>

@code {
    private static readonly MudTheme BybitTheme = new()
    {
        PaletteDark = new PaletteDark
        {
            Primary = "#F5A623",
            Secondary = "#2EBD85",
            Tertiary = "#3B82F6",
            Info = "#3B82F6",
            Success = "#2EBD85",
            Warning = "#F5A623",
            Error = "#EF4444",
            Background = "#0B0D10",
            Surface = "#11161C",
            AppbarBackground = "#0F1318",
            AppbarText = "#E5E7EB",
            DrawerBackground = "#0F1318",
            DrawerText = "#E5E7EB",
            TextPrimary = "#F3F4F6",
            TextSecondary = "#B9C0CC",
            TextDisabled = "#6B7280",
            ActionDefault = "#F3F4F6",
            ActionDisabled = "#4B5563",
            ActionDisabledBackground = "#1B222A",
            LinesDefault = "#26303A",
            LinesInputs = "#2C3944",
            TableLines = "#26303A",
            Divider = "#1E2730",
            GrayDefault = "#9AA4B2",
            GrayLight = "#C2C8D1",
            GrayLighter = "#E3E6EA",
            GrayDark = "#6B7280",
            Black = "#000000",
            White = "#FFFFFF"
        },
        LayoutProperties = new LayoutProperties
        {
            DefaultBorderRadius = "8px"
        }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        await Task.CompletedTask;
    }

    private void HandleIsDarkModeChanged(bool isDarkMode)
    {
        if (_isDarkMode == isDarkMode)
        {
            return;
        }

        _isDarkMode = isDarkMode;
        _ = InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        if (_systemThemeModule is not null)
        {
            await _systemThemeModule.DisposeAsync();
        }
    }

    private MudThemeProvider? _mudThemeProvider;
    private bool _isDarkMode;
    private IJSObjectReference? _systemThemeModule;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _systemThemeModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/system-theme.js");
            _isDarkMode = await _systemThemeModule.InvokeAsync<bool>("getSystemDarkMode");
        }
        catch (JSException)
        {
            _isDarkMode = false;
        }
    }
}
