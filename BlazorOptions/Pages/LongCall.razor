@page "/long-call"
@inject PositionBuilderViewModel ViewModel
@inject IJSRuntime JS

<PageTitle>Multi-leg ETH/USDT Position</PageTitle>

<MudStack Spacing="3">
    <MudCard>
        <MudCardContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h4">@ViewModel.Pair Position</MudText>
                    <MudText Typo="Typo.subtitle2">Construct calls, puts, and futures legs for the pair.</MudText>
                </MudStack>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudSelect T="Guid" Label="Position" Value="@SelectedPositionId" ValueChanged="async (Guid id) => await OnPositionChanged(id)" Dense="true">
                        @foreach (var position in ViewModel.Positions)
                        {
                            <MudSelectItem Value="@position.Id">@position.Pair</MudSelectItem>
                        }
                    </MudSelect>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.LibraryAdd" OnClick="CreatePosition">New position</MudButton>
                    <MudTextField Value="@ViewModel.Pair"
                                   ValueChanged="async (string pair) => await OnPairChanged(pair)"
                                   Label="Pair"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.Link" />
                </MudStack>
            </MudStack>
        </MudCardContent>
        <MudCardContent Class="chart-container">
            <MudPaper Class="pa-4 chart-surface" Elevation="0">
                <div class="chart-host">
                    <div class="echart" @ref="_chartRef"></div>
                </div>
            </MudPaper>
        </MudCardContent>
    </MudCard>

    <MudCard>
        <MudCardHeader>
            <MudText Typo="Typo.h6">Legs</MudText>
            <MudSpacer />
            <MudTooltip Text="Add leg">
                <MudIconButton Icon="@Icons.Material.Filled.AddCircle" Color="Color.Primary" OnClick="OnAddLeg" />
            </MudTooltip>
        </MudCardHeader>
        <MudCardContent>
            <MudTable Items="@ViewModel.Legs" Dense="true" Hover="true" Class="leg-table">
                <HeaderContent>
                    <MudTh>Include</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Strike</MudTh>
                    <MudTh>Expiration</MudTh>
                    <MudTh>Size</MudTh>
                    <MudTh>Price</MudTh>
                    <MudTh>IV</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Include">
                        <MudCheckBox T="bool"
                                     Value="@context.IsIncluded"
                                     ValueChanged="async checkedValue => await OnLegIncludedChanged(context, checkedValue)" />
                    </MudTd>
                    <MudTd DataLabel="Type">
                        <MudSelect T="OptionLegType" Value="@context.Type" ValueChanged="async type => await OnLegTypeChanged(context, type)" Dense="true">
                            @foreach (var type in LegTypes)
                            {
                                <MudSelectItem Value="@type">@type</MudSelectItem>
                            }
                        </MudSelect>
                    </MudTd>
                    <MudTd DataLabel="Strike">
                        <MudNumericField T="double" Value="@context.Strike" ValueChanged="async value => await OnLegStrikeChanged(context, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="USDT" />
                    </MudTd>
                    <MudTd DataLabel="Expiration">
                        <MudDatePicker Date="context.ExpirationDate"
                                       DateChanged="date => OnExpirationChanged(context, date)"
                                       DateFormat="yyyy-MM-dd"
                                       Class="full-width" />
                    </MudTd>
                    <MudTd DataLabel="Size">
                        <MudNumericField T="double" Value="@context.Size" ValueChanged="async value => await OnLegSizeChanged(context, value)" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudTd>
                    <MudTd DataLabel="Price">
                        <MudNumericField T="double" Value="@context.Price" ValueChanged="async value => await OnLegPriceChanged(context, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="USDT" />
                    </MudTd>
                    <MudTd DataLabel="IV">
                        <MudNumericField T="double" Value="@context.ImpliedVolatility" ValueChanged="async value => await OnLegIvChanged(context, value)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.End" AdornmentText="%" />
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align:right;">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => OnRemoveLeg(context)" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudStack>

@code {
    private ElementReference _chartRef;
    private IEnumerable<OptionLegType> LegTypes => Enum.GetValues<OptionLegType>();

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.InitializeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RenderChartAsync();
        }
    }

    private async Task RenderChartAsync()
    {
        await JS.InvokeVoidAsync("payoffChart.render", _chartRef, ViewModel.ChartConfig);
    }

    private async Task OnAddLeg()
    {
        await ViewModel.AddLegAsync();
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }

    private async Task OnRemoveLeg(OptionLegModel leg)
    {
        if (await ViewModel.RemoveLegAsync(leg))
        {
            ViewModel.UpdateChart();
            await RenderChartAsync();
        }
    }

    private async Task OnLegIncludedChanged(OptionLegModel leg, bool include)
    {
        leg.IsIncluded = include;
        await ViewModel.PersistPositionsAsync();
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }

    private async Task OnLegTypeChanged(OptionLegModel leg, OptionLegType type)
    {
        leg.Type = type;
        await ViewModel.PersistPositionsAsync();
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }

    private async Task OnLegStrikeChanged(OptionLegModel leg, double strike)
    {
        leg.Strike = strike;
        await ViewModel.PersistPositionsAsync();
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }

    private async Task OnExpirationChanged(OptionLegModel leg, DateTime? date)
    {
        if (date.HasValue)
        {
            leg.ExpirationDate = date.Value;
        }

        await ViewModel.PersistPositionsAsync();
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }

    private async Task OnLegSizeChanged(OptionLegModel leg, double size)
    {
        leg.Size = size;
        await ViewModel.PersistPositionsAsync();
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }

    private async Task OnLegPriceChanged(OptionLegModel leg, double price)
    {
        leg.Price = price;
        await ViewModel.PersistPositionsAsync();
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }

    private async Task OnLegIvChanged(OptionLegModel leg, double iv)
    {
        leg.ImpliedVolatility = iv;
        await ViewModel.PersistPositionsAsync();
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }

    private Guid SelectedPositionId => ViewModel.SelectedPosition?.Id ?? Guid.Empty;

    private async Task OnPositionChanged(Guid positionId)
    {
        if (positionId == Guid.Empty)
        {
            return;
        }

        if (await ViewModel.SelectPositionAsync(positionId))
        {
            ViewModel.UpdateChart();
            await RenderChartAsync();
            StateHasChanged();
        }
    }

    private async Task CreatePosition()
    {
        await ViewModel.AddPositionAsync();
        await RenderChartAsync();
        StateHasChanged();
    }

    private async Task OnPairChanged(string pair)
    {
        await ViewModel.UpdatePairAsync(pair);
        ViewModel.UpdateChart();
        await RenderChartAsync();
    }
}
