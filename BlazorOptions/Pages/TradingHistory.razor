@page "/trading-history"
@implements IDisposable
@using BlazorOptions.Shared
@using System.Globalization
@inject TradingHistoryViewModel ViewModel
@inject INavigationService NavigationService

<PageTitle>Trading history</PageTitle>

<MudStack Spacing="3" Class="trading-history-page">
    <MudText Typo="Typo.h4">Trading history</MudText>
    <MudText Typo="Typo.body2">
        Pull the latest transaction log entries and review recent activity.
    </MudText>

    <MudTabs Rounded="true">
        <MudTabPanel Text="History">
            <MudStack Spacing="3">
                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Load transactions</MudText>
                        @if (ViewModel.IsRegistrationDateRequired)
                        {
                            <MudDatePicker Date="@ViewModel.RegistrationDate"
                                           DateChanged="OnRegistrationDateChanged"
                                           Label="Registration date (optional)"
                                           DateFormat="yyyy-MM-dd"
                                           Clearable="true" />
                            <MudText Typo="Typo.caption">
                                Select the date you registered on Bybit to backfill older history.
                            </MudText>
                        }
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="th-controls-row">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Download"
                                       Class="th-control-button"
                                       Disabled="ViewModel.IsLoading"
                                       OnClick="LoadAsync">
                                @(ViewModel.IsLoading ? "Loading..." : "Load")
                            </MudButton>
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Default"
                                       StartIcon="@Icons.Material.Filled.Autorenew"
                                       Class="th-control-button"
                                       Disabled="ViewModel.IsLoading || ViewModel.IsLoadingOlder || ViewModel.TotalTransactionsCount == 0"
                                       OnClick="RecalculateAsync">
                                Recalculate
                            </MudButton>
                            <MudDatePicker Date="@_recalculateFromDate"
                                           DateChanged="OnRecalculateDateChanged"
                                           Label="Recalculate from"
                                           Class="th-recalc-date"
                                           DateFormat="yyyy-MM-dd"
                                           Clearable="true"
                                           Disabled="ViewModel.IsLoading || ViewModel.IsLoadingOlder || ViewModel.TotalTransactionsCount == 0" />
                            @if (ViewModel.LastLoadedAt.HasValue)
                            {
                                <MudText Typo="Typo.caption">
                                    Last loaded @ViewModel.LastLoadedAt.Value.ToLocalTime().ToString("g")
                                </MudText>
                            }
                        </MudStack>
                        <MudText Typo="Typo.caption">
                            Loads new entries since the last sync. If registration date is set, backfills from that date for: linear, inverse, spot, option.
                        </MudText>
                        <MudText Typo="Typo.caption" Class="th-endpoint-note">
                            Endpoint: https://bybit-exchange.github.io/docs/v5/account/transaction-log
                        </MudText>
                        @if (!string.IsNullOrWhiteSpace(ViewModel.ErrorMessage))
                        {
                            <MudAlert Severity="Severity.Error">@ViewModel.ErrorMessage</MudAlert>
                        }
                    </MudStack>
                </MudPaper>

                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Recent transactions</MudText>
                        <div class="th-desktop-only">
                            <MudDataGrid T="TradingHistoryEntry"
                                         @key="_gridVersion"
                                         VirtualizeServerData="ServerDataFunc"
                                         Virtualize="true"
                                         Filterable="true"
                                         FixedHeader="true"
                                         Height="400px"
                                         ItemSize="52.68f">
                                <Columns>
                                    <TemplateColumn Title="Date">
                                        <CellTemplate>
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2">@FormatTimestamp(context.Item.Timestamp)</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.TransactionType</MudText>
                                            </MudStack>
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <TemplateColumn Title="Trade">
                                        <CellTemplate>
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2">
                                                    @context.Item.Side @context.Item.TransactionType @context.Item.Size
                                                    <MudLink OnClick="@(() => OpenSymbolDialogAsync(context.Item.Symbol, context.Item.Category))">
                                                        @context.Item.Symbol
                                                    </MudLink>
                                                </MudText>
                                            </MudStack>
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <TemplateColumn Title="Price">
                                        <CellTemplate>
                                            @context.Item.Price
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <TemplateColumn Title="Value">
                                        <CellTemplate>
                                            @($"{FormatValue(context.Item.Size, context.Item.Price)} {context.Item.Currency}")
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <TemplateColumn Title="Fee">
                                        <CellTemplate>
                                            @($"{context.Item.Fee} {context.Item.Currency}")
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <PropertyColumn Property="x => x.Calculated.SizeAfter" Title="Size after" />
                                    <PropertyColumn Property="x => x.Calculated.AvgPriceAfter" Title="Avg price after" />
                                    <PropertyColumn Property="x => x.Calculated.RealizedPnl" Format="0.00" Title="Realized PnL" />
                                    <PropertyColumn Property="x => x.Calculated.CumulativePnl" Format="0.00" Title="Cumulative PnL" />
                                </Columns>
                                <RowLoadingContent>
                                    <tr class="mud-table-row">
                                        <td class="mud-table-cell" colspan="1000">
                                            Loading...
                                        </td>
                                    </tr>
                                </RowLoadingContent>
                            </MudDataGrid>
                        </div>
                        <div class="th-mobile-only">
                            <MudStack Spacing="2">
                                @foreach (var entry in _mobileRecentEntries)
                                {
                                    <MudPaper Elevation="0" Class="pa-3 th-mobile-entry" @key="entry.Id">
                                        <MudStack Spacing="1">
                                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                <MudText Typo="Typo.caption">@FormatTimestamp(entry.Timestamp)</MudText>
                                                <MudText Typo="Typo.caption" Color="@(entry.Calculated.CumulativePnl >= 0 ? Color.Success : Color.Error)">
                                                    Cumulative P/L: @entry.Calculated.CumulativePnl.ToString("0.##", CultureInfo.InvariantCulture)
                                                </MudText>
                                            </MudStack>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@entry.TransactionType</MudText>
                                            <MudText Typo="Typo.body2">
                                                @entry.Side @entry.Size
                                                <MudLink OnClick="@(() => OpenSymbolDialogAsync(entry.Symbol, entry.Category))">@entry.Symbol</MudLink>
                                            </MudText>
                                            <MudText Typo="Typo.caption">Price: @entry.Price</MudText>
                                            <MudText Typo="Typo.caption">Value: @FormatValue(entry.Size, entry.Price) @entry.Currency</MudText>
                                            <MudText Typo="Typo.caption">Fee: @entry.Fee @entry.Currency</MudText>
                                            <MudText Typo="Typo.caption">Realized: @entry.Calculated.RealizedPnl.ToString("0.##", CultureInfo.InvariantCulture)</MudText>
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        </div>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudTabPanel>
        <MudTabPanel Text="Summary">
            <MudStack Spacing="3">
                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Realized PnL per day</MudText>
                        @if (ViewModel.TotalTransactionsCount == 0)
                        {
                            <MudText Typo="Typo.body2">No transactions loaded yet.</MudText>
                        }
                        else if (ViewModel.GetDailyRealizedPnlChart() is { } dailyChart)
                        {
                            <DailyPnlChart Config="dailyChart" Height="280px" />
                        }
                        else
                        {
                            <MudText Typo="Typo.body2">Preparing daily chart...</MudText>
                        }
                    </MudStack>
                </MudPaper>

                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Totals by symbol</MudText>
                        @if (ViewModel.TotalTransactionsCount == 0)
                        {
                            <MudText Typo="Typo.body2">No transactions loaded yet.</MudText>
                        }
                        else
                        {
                            <div class="th-desktop-only">
                                <MudTable Items="ViewModel.GetSummaryBySymbol()"
                                      Hover="true"
                                      Dense="true"
                                      FixedHeader="true"
                                      Height="500px"
                                      GroupBy="@_summaryGroupDefinition"
                                      GroupHeaderStyle="background-color: var(--mud-palette-background-gray);">
                                <HeaderContent>
                                    <MudTh>Symbol</MudTh>
                                    <MudTh align="right">Trades</MudTh>
                                    <MudTh align="right">Qty</MudTh>
                                    <MudTh align="right">Value</MudTh>
                                    <MudTh align="right">Fees</MudTh>
                                    <MudTh align="right">Realized PnL</MudTh>
                                </HeaderContent>
                                <GroupHeaderTemplate>
                                    <MudTh Class="mud-table-cell-custom-group" colspan="6">
                                        @($"{context.GroupName}: {context.Key}")
                                    </MudTh>
                                </GroupHeaderTemplate>
                                <RowTemplate>
                                    <MudTd DataLabel="Symbol">
                                        <MudLink OnClick="@(() => OpenSymbolDialogAsync(context.Symbol, context.Category))">
                                            @context.Symbol
                                        </MudLink>
                                    </MudTd>
                                    <MudTd DataLabel="Trades" Style="text-align:right;">@context.Trades</MudTd>
                                    <MudTd DataLabel="Qty" Style="text-align:right;">@context.TotalQty</MudTd>
                                    <MudTd DataLabel="Value" Style="text-align:right;">@context.TotalValue</MudTd>
                                    <MudTd DataLabel="Fees" Style="text-align:right;">@context.TotalFees</MudTd>
                                    <MudTd DataLabel="Realized PnL" Style="text-align:right;">@context.RealizedPnl</MudTd>
                                </RowTemplate>
                                </MudTable>
                            </div>
                            <div class="th-mobile-only">
                                <MudStack Spacing="2">
                                    @foreach (var row in ViewModel.GetSummaryBySymbol())
                                    {
                                        <MudPaper Elevation="0" Class="pa-3 th-mobile-entry" @key="row.Symbol">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@row.GroupKey</MudText>
                                            <MudText Typo="Typo.subtitle2">
                                                <MudLink OnClick="@(() => OpenSymbolDialogAsync(row.Symbol, row.Category))">@row.Symbol</MudLink>
                                            </MudText>
                                            <MudText Typo="Typo.caption">Trades: @row.Trades</MudText>
                                            <MudText Typo="Typo.caption">Qty: @row.TotalQty</MudText>
                                            <MudText Typo="Typo.caption">Value: @row.TotalValue</MudText>
                                            <MudText Typo="Typo.caption">Fees: @row.TotalFees</MudText>
                                            <MudText Typo="Typo.caption">PnL: @row.RealizedPnl</MudText>
                                        </MudPaper>
                                    }
                                </MudStack>
                            </div>
                        }
                    </MudStack>
                </MudPaper>

                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Realized PnL by settle coin</MudText>
                        @if (ViewModel.TotalTransactionsCount == 0)
                        {
                            <MudText Typo="Typo.body2">No transactions loaded yet.</MudText>
                        }
                        else
                        {
                            <div class="th-desktop-only">
                                <MudTable Items="ViewModel.GetRealizedPnlBySettleCoin()"
                                      Hover="true"
                                      Dense="true"
                                      FixedHeader="true"
                                      Height="300px">
                                <HeaderContent>
                                    <MudTh>Settle coin</MudTh>
                                    <MudTh align="right">Realized PnL</MudTh>
                                    <MudTh align="right">Fees</MudTh>
                                    <MudTh align="right">Net PnL</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Settle coin">@context.SettleCoin</MudTd>
                                    <MudTd DataLabel="Realized PnL" Style="text-align:right;">@context.RealizedPnl</MudTd>
                                    <MudTd DataLabel="Fees" Style="text-align:right;">@context.Fees</MudTd>
                                    <MudTd DataLabel="Net PnL" Style="text-align:right;">@context.NetPnl</MudTd>
                                </RowTemplate>
                                </MudTable>
                            </div>
                            <div class="th-mobile-only">
                                <MudStack Spacing="2">
                                    @foreach (var row in ViewModel.GetRealizedPnlBySettleCoin())
                                    {
                                        <MudPaper Elevation="0" Class="pa-3 th-mobile-entry" @key="row.SettleCoin">
                                            <MudText Typo="Typo.subtitle2">@row.SettleCoin</MudText>
                                            <MudText Typo="Typo.caption">Realized: @row.RealizedPnl</MudText>
                                            <MudText Typo="Typo.caption">Fees: @row.Fees</MudText>
                                            <MudText Typo="Typo.caption">Net: @row.NetPnl</MudText>
                                        </MudPaper>
                                    }
                                </MudStack>
                            </div>
                        }
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudTabPanel>
    </MudTabs>
</MudStack>

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.OnChange += HandleViewModelChanged;
        await ViewModel.InitializeAsync();
        await RefreshMobileRecentEntriesAsync();
    }

    public void Dispose()
    {
        ViewModel.OnChange -= HandleViewModelChanged;
    }

    private Task LoadAsync()
    {
        return LoadAndRefreshAsync();
    }

    private Task OnRegistrationDateChanged(DateTime? date)
    {
        return ViewModel.SetRegistrationDateAsync(date);
    }

    private async Task<GridData<TradingHistoryEntry>> ServerDataFunc(
        GridStateVirtualize<TradingHistoryEntry> state,
        CancellationToken cancellationToken)
    {
        int pageSize = state.Count;
        if (pageSize <= 0) pageSize = 50;

        var result = await ViewModel.LoadEntriesAsync(null, state.StartIndex, pageSize);
        return new GridData<TradingHistoryEntry> { Items = result.Entries, TotalItems = result.TotalEntries };
    }

    private async Task OpenSymbolDialogAsync(string symbol, string? category = null)
    {
        if (string.IsNullOrWhiteSpace(symbol))
        {
            return;
        }

        await NavigationService.NavigateToAsync<TradingSymbolDialogViewModel>(viewModel =>
            viewModel.LoadAsync(symbol, category, null));
    }

    private void HandleViewModelChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task LoadAndRefreshAsync()
    {
        await ViewModel.LoadLatestAsync();
        _gridVersion++;
        await RefreshMobileRecentEntriesAsync();
    }

    private async Task RecalculateAsync()
    {
        await ViewModel.RecalculateAsync(_recalculateFromDate);
        _gridVersion++;
        await RefreshMobileRecentEntriesAsync();
    }

    private Task OnRecalculateDateChanged(DateTime? date)
    {
        _recalculateFromDate = date;
        return Task.CompletedTask;
    }

    private int _gridVersion;
    private DateTime? _recalculateFromDate;
    private IReadOnlyList<TradingHistoryEntry> _mobileRecentEntries = Array.Empty<TradingHistoryEntry>();

    private async Task RefreshMobileRecentEntriesAsync()
    {
        var result = await ViewModel.LoadEntriesAsync(null, 0, 30);
        _mobileRecentEntries = result.Entries.ToArray();
    }
    
    private static string FormatTimestamp(long? timestamp)
    {
        if (!timestamp.HasValue || timestamp.Value <= 0)
        {
            return "N/A";
        }

        try
        {
            return DateTimeOffset.FromUnixTimeMilliseconds(timestamp.Value)
                .ToLocalTime()
                .ToString("g");
        }
        catch
        {
            return "N/A";
        }
    }

    private static string FormatValue(decimal qty, decimal price)
    {
        return (qty * price).ToString("0.##########", CultureInfo.InvariantCulture);
    }

    private readonly TableGroupDefinition<TradingSummaryRow> _summaryGroupDefinition =
        new(item => item.GroupKey)
        {
            GroupName = "Category / Settle"
        };
}

<style>
    .th-mobile-only {
        display: none;
    }

    .th-mobile-entry {
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.01);
    }

    @@media (max-width: 768px) {
        .trading-history-page {
            gap: 12px !important;
        }

        .th-controls-row {
            flex-direction: column !important;
            align-items: stretch !important;
        }

        .th-control-button,
        .th-recalc-date {
            width: 100%;
        }

        .th-endpoint-note {
            display: none;
        }

        .th-desktop-only {
            display: none;
        }

        .th-mobile-only {
            display: block;
        }
    }
</style>
