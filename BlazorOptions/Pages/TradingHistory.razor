@page "/trading-history"
@implements IDisposable
@using BlazorOptions.Shared
@using System.Globalization
@inject TradingHistoryViewModel ViewModel
@inject INavigationService NavigationService

<PageTitle>Trading history</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4">Trading history</MudText>
    <MudText Typo="Typo.body2">
        Pull the latest transaction log entries and review recent activity.
    </MudText>

    <MudTabs Rounded="true">
        <MudTabPanel Text="History">
            <MudStack Spacing="3">
                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Load transactions</MudText>
                        @if (ViewModel.IsRegistrationDateRequired)
                        {
                            <MudDatePicker Date="@ViewModel.RegistrationDate"
                                           DateChanged="OnRegistrationDateChanged"
                                           Label="Registration date (optional)"
                                           DateFormat="yyyy-MM-dd"
                                           Clearable="true" />
                            <MudText Typo="Typo.caption">
                                Select the date you registered on Bybit to backfill older history.
                            </MudText>
                        }
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Download"
                                       Disabled="ViewModel.IsLoading"
                                       OnClick="LoadAsync">
                                @(ViewModel.IsLoading ? "Loading..." : "Load")
                            </MudButton>
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Default"
                                       StartIcon="@Icons.Material.Filled.Autorenew"
                                       Disabled="ViewModel.IsLoading || ViewModel.IsLoadingOlder || ViewModel.TotalTransactionsCount == 0"
                                       OnClick="RecalculateAsync">
                                Recalculate
                            </MudButton>
                            <MudDatePicker Date="@_recalculateFromDate"
                                           DateChanged="OnRecalculateDateChanged"
                                           Label="Recalculate from"
                                           DateFormat="yyyy-MM-dd"
                                           Clearable="true"
                                           Disabled="ViewModel.IsLoading || ViewModel.IsLoadingOlder || ViewModel.TotalTransactionsCount == 0" />
                            @if (ViewModel.LastLoadedAt.HasValue)
                            {
                                <MudText Typo="Typo.caption">
                                    Last loaded @ViewModel.LastLoadedAt.Value.ToLocalTime().ToString("g")
                                </MudText>
                            }
                        </MudStack>
                        <MudText Typo="Typo.caption">
                            Loads new entries since the last sync. If registration date is set, backfills from that date for: linear, inverse, spot, option.
                        </MudText>
                        <MudText Typo="Typo.caption">
                            Endpoint: https://bybit-exchange.github.io/docs/v5/account/transaction-log
                        </MudText>
                        @if (!string.IsNullOrWhiteSpace(ViewModel.ErrorMessage))
                        {
                            <MudAlert Severity="Severity.Error">@ViewModel.ErrorMessage</MudAlert>
                        }
                    </MudStack>
                </MudPaper>

                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Recent transactions</MudText>
                            <MudDataGrid T="TradingHistoryEntry"
                                         @key="_gridVersion"
                                         VirtualizeServerData="ServerDataFunc"
                                         Virtualize="true"
                                         Filterable="true"
                                         FixedHeader="true"
                                         Height="400px"
                                         ItemSize="52.68f">
                                <Columns>
                                    <TemplateColumn Title="Date">
                                        <CellTemplate>
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2">@FormatTimestamp(context.Item.Timestamp)</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.TransactionType</MudText>
                                            </MudStack>
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <TemplateColumn Title="Trade">
                                        <CellTemplate>
                                            <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2">
                                            @context.Item.Side @context.Item.TransactionType @context.Item.Size
                                            <MudLink OnClick="@(() => OpenSymbolDialogAsync(context.Item.Symbol, context.Item.Category))">
                                                @context.Item.Symbol
                                            </MudLink>
                                        </MudText>
                                    </MudStack>
                                </CellTemplate>
                            </TemplateColumn>
                                    <TemplateColumn Title="Price">
                                        <CellTemplate>
                                @context.Item.Price
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <TemplateColumn Title="Value">
                                        <CellTemplate>
                                @($"{FormatValue(context.Item.Size, context.Item.Price)} {context.Item.Currency}")
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <TemplateColumn Title="Fee">
                                        <CellTemplate>
                                @($"{context.Item.Fee} {context.Item.Currency}")
                                        </CellTemplate>
                                    </TemplateColumn>
                                    <PropertyColumn Property="x => x.Calculated.SizeAfter" Title="Size after" />
                                    <PropertyColumn Property="x => x.Calculated.AvgPriceAfter" Title="Avg price after" />
                                    <PropertyColumn Property="x => x.Calculated.RealizedPnl" Format="0.00" Title="Realized PnL" />
                                    <PropertyColumn Property="x => x.Calculated.CumulativePnl" Format="0.00" Title="Cumulative PnL" />
                                </Columns>
                                <RowLoadingContent>
                                    <tr class="mud-table-row">
                                        <td class="mud-table-cell" colspan="1000">
                                            Loading...
                                        </td>
                                    </tr>
                                </RowLoadingContent>
                            </MudDataGrid>
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudTabPanel>
        <MudTabPanel Text="Summary">
            <MudStack Spacing="3">
                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Realized PnL per day</MudText>
                        @if (ViewModel.TotalTransactionsCount == 0)
                        {
                            <MudText Typo="Typo.body2">No transactions loaded yet.</MudText>
                        }
                        else if (ViewModel.GetDailyRealizedPnlChart() is { } dailyChart)
                        {
                            <DailyPnlChart Config="dailyChart" Height="280px" />
                        }
                        else
                        {
                            <MudText Typo="Typo.body2">Preparing daily chart...</MudText>
                        }
                    </MudStack>
                </MudPaper>

                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Totals by symbol</MudText>
                        @if (ViewModel.TotalTransactionsCount == 0)
                        {
                            <MudText Typo="Typo.body2">No transactions loaded yet.</MudText>
                        }
                        else
                        {
                            <MudTable Items="ViewModel.GetSummaryBySymbol()"
                                      Hover="true"
                                      Dense="true"
                                      FixedHeader="true"
                                      Height="500px"
                                      GroupBy="@_summaryGroupDefinition"
                                      GroupHeaderStyle="background-color: var(--mud-palette-background-gray);">
                                <HeaderContent>
                                    <MudTh>Symbol</MudTh>
                                    <MudTh align="right">Trades</MudTh>
                                    <MudTh align="right">Qty</MudTh>
                                    <MudTh align="right">Value</MudTh>
                                    <MudTh align="right">Fees</MudTh>
                                    <MudTh align="right">Realized PnL</MudTh>
                                </HeaderContent>
                                <GroupHeaderTemplate>
                                    <MudTh Class="mud-table-cell-custom-group" colspan="6">
                                        @($"{context.GroupName}: {context.Key}")
                                    </MudTh>
                                </GroupHeaderTemplate>
                                <RowTemplate>
                                    <MudTd DataLabel="Symbol">
                                        <MudLink OnClick="@(() => OpenSymbolDialogAsync(context.Symbol, context.Category))">
                                            @context.Symbol
                                        </MudLink>
                                    </MudTd>
                                    <MudTd DataLabel="Trades" Style="text-align:right;">@context.Trades</MudTd>
                                    <MudTd DataLabel="Qty" Style="text-align:right;">@context.TotalQty</MudTd>
                                    <MudTd DataLabel="Value" Style="text-align:right;">@context.TotalValue</MudTd>
                                    <MudTd DataLabel="Fees" Style="text-align:right;">@context.TotalFees</MudTd>
                                    <MudTd DataLabel="Realized PnL" Style="text-align:right;">@context.RealizedPnl</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </MudStack>
                </MudPaper>

                <MudPaper Class="pa-6" Elevation="1">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6">Realized PnL by settle coin</MudText>
                        @if (ViewModel.TotalTransactionsCount == 0)
                        {
                            <MudText Typo="Typo.body2">No transactions loaded yet.</MudText>
                        }
                        else
                        {
                            <MudTable Items="ViewModel.GetRealizedPnlBySettleCoin()"
                                      Hover="true"
                                      Dense="true"
                                      FixedHeader="true"
                                      Height="300px">
                                <HeaderContent>
                                    <MudTh>Settle coin</MudTh>
                                    <MudTh align="right">Realized PnL</MudTh>
                                    <MudTh align="right">Fees</MudTh>
                                    <MudTh align="right">Net PnL</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Settle coin">@context.SettleCoin</MudTd>
                                    <MudTd DataLabel="Realized PnL" Style="text-align:right;">@context.RealizedPnl</MudTd>
                                    <MudTd DataLabel="Fees" Style="text-align:right;">@context.Fees</MudTd>
                                    <MudTd DataLabel="Net PnL" Style="text-align:right;">@context.NetPnl</MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                    </MudStack>
                </MudPaper>
            </MudStack>
        </MudTabPanel>
    </MudTabs>
</MudStack>

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.OnChange += HandleViewModelChanged;
        await ViewModel.InitializeAsync();
    }

    public void Dispose()
    {
        ViewModel.OnChange -= HandleViewModelChanged;
    }

    private Task LoadAsync()
    {
        return LoadAndRefreshAsync();
    }

    private Task OnRegistrationDateChanged(DateTime? date)
    {
        return ViewModel.SetRegistrationDateAsync(date);
    }

    private async Task<GridData<TradingHistoryEntry>> ServerDataFunc(
        GridStateVirtualize<TradingHistoryEntry> state,
        CancellationToken cancellationToken)
    {
        int pageSize = state.Count;
        if (pageSize <= 0) pageSize = 50;

        var result = await ViewModel.LoadEntriesAsync(null, state.StartIndex, pageSize);
        return new GridData<TradingHistoryEntry> { Items = result.Entries, TotalItems = result.TotalEntries };
    }

    private async Task OpenSymbolDialogAsync(string symbol, string? category = null)
    {
        if (string.IsNullOrWhiteSpace(symbol))
        {
            return;
        }

        await NavigationService.NavigateToAsync<TradingSymbolDialogViewModel>(viewModel =>
            viewModel.LoadAsync(symbol, category, null));
    }

    private void HandleViewModelChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task LoadAndRefreshAsync()
    {
        await ViewModel.LoadLatestAsync();
        _gridVersion++;
    }

    private async Task RecalculateAsync()
    {
        await ViewModel.RecalculateAsync(_recalculateFromDate);
        _gridVersion++;
    }

    private Task OnRecalculateDateChanged(DateTime? date)
    {
        _recalculateFromDate = date;
        return Task.CompletedTask;
    }

    private int _gridVersion;
    private DateTime? _recalculateFromDate;
    
    private static string FormatTimestamp(long? timestamp)
    {
        if (!timestamp.HasValue || timestamp.Value <= 0)
        {
            return "N/A";
        }

        try
        {
            return DateTimeOffset.FromUnixTimeMilliseconds(timestamp.Value)
                .ToLocalTime()
                .ToString("g");
        }
        catch
        {
            return "N/A";
        }
    }

    private static string FormatValue(decimal qty, decimal price)
    {
        return (qty * price).ToString("0.##########", CultureInfo.InvariantCulture);
    }

    private readonly TableGroupDefinition<TradingSummaryRow> _summaryGroupDefinition =
        new(item => item.GroupKey)
        {
            GroupName = "Category / Settle"
        };
}
