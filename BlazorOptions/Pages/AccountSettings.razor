@page "/account-settings"
@implements IDisposable
@inject BlazorOptions.ViewModels.AccountSettingsViewModel ViewModel

<PageTitle>Account settings</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4">Account settings</MudText>

    <MudPaper Class="pa-6" Elevation="1">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6">Sync account</MudText>

            @if (ViewModel.IsAuthenticated)
            {
                <MudTextField Label="User name" Value="ViewModel.CurrentUserName" ReadOnly="true" />
                <MudButton Variant="Variant.Text" Color="Color.Secondary" Disabled="ViewModel.IsAuthBusy" OnClick="HandleLogoutAsync">
                    Sign out
                </MudButton>
            }
            else
            {
                <MudText Typo="Typo.body2">@ViewModel.AuthStatusLabel</MudText>
                <MudTextField Label="User name" @bind-Value="ViewModel.UserName" Disabled="ViewModel.IsAuthBusy" />
                <MudTextField Label="Password" InputType="InputType.Password" @bind-Value="ViewModel.Password" Disabled="ViewModel.IsAuthBusy" />

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="ViewModel.IsAuthBusy" OnClick="HandleRegisterAsync">
                        Register
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="ViewModel.IsAuthBusy" OnClick="HandleLoginAsync">
                        Sign in
                    </MudButton>
                </MudStack>

                @if (!string.IsNullOrWhiteSpace(ViewModel.AuthError))
                {
                    <MudText Typo="Typo.caption" Color="Color.Error">@ViewModel.AuthError</MudText>
                }
            }
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-6" Elevation="1">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6">Risk thresholds</MudText>
            <MudNumericField T="decimal"
                             Label="Max loss for options (%)"
                             @bind-Value="ViewModel.MaxLossOptionPercent"
                             Min="1"
                             Step="1" />
            <MudNumericField T="decimal"
                             Label="Max loss for futures (%)"
                             @bind-Value="ViewModel.MaxLossFuturesPercent"
                             Min="1"
                             Step="1" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleSaveRiskSettingsAsync">
                Save thresholds
            </MudButton>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-6" Elevation="1">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6">Bybit settings</MudText>
            <MudTextField Label="API key"
                          @bind-Value="ViewModel.ApiKey"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense" />
            <MudTextField Label="API secret"
                          @bind-Value="ViewModel.ApiSecret"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          InputType="InputType.Password" />
            <MudTextField Label="WebSocket URL"
                          @bind-Value="ViewModel.WebSocketUrl"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense" />
            <MudNumericField T="int"
                             Label="Live price update interval (milliseconds)"
                             @bind-Value="ViewModel.LivePriceUpdateIntervalMilliseconds"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Min="100" />
            <MudTextField Label="Options base coins"
                          @bind-Value="ViewModel.OptionBaseCoins"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          HelperText="Examples: BTC, ETH, SOL. Any non-letter/digit separator is supported." />
            <MudTextField Label="Options quote coins"
                          @bind-Value="ViewModel.OptionQuoteCoins"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          HelperText="Examples: USDT, USDC. Any non-letter/digit separator is supported." />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleSaveBybitSettingsAsync">
                Save Bybit settings
            </MudButton>
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    protected override void OnInitialized()
    {
        ViewModel.OnChange += HandleViewModelChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.InitializeAsync();
    }

    public void Dispose()
    {
        ViewModel.OnChange -= HandleViewModelChanged;
        ViewModel.Dispose();
    }

    private void HandleViewModelChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private Task HandleRegisterAsync()
    {
        return ViewModel.RegisterAsync();
    }

    private Task HandleLoginAsync()
    {
        return ViewModel.LoginAsync();
    }

    private Task HandleLogoutAsync()
    {
        return ViewModel.LogoutAsync();
    }

    private Task HandleSaveRiskSettingsAsync()
    {
        return ViewModel.SaveRiskSettingsAsync();
    }

    private Task HandleSaveBybitSettingsAsync()
    {
        return ViewModel.SaveBybitSettingsAsync();
    }
}
