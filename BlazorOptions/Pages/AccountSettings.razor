@page "/account-settings"
@implements IDisposable
@inject BlazorOptions.ViewModels.AccountSettingsViewModel ViewModel

<PageTitle>Account settings</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4">Account settings</MudText>

    <MudPaper Class="pa-6" Elevation="1">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6">Appearance</MudText>
            <MudSelect T="ThemeMode" Label="Theme" @bind-Value="ViewModel.SelectedTheme">
                @foreach (var option in ViewModel.ThemeOptions)
                {
                    <MudSelectItem Value="option.Mode">@option.Label</MudSelectItem>
                }
            </MudSelect>
            <MudText Typo="Typo.body2" Color="Color.Secondary">@ViewModel.SelectedThemeDescription</MudText>
            <MudText Typo="Typo.caption">@ViewModel.SystemPreferenceLabel</MudText>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-6" Elevation="1">
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6">Sync account</MudText>

            @if (ViewModel.IsAuthenticated)
            {
                <MudTextField Label="User name" Value="ViewModel.CurrentUserName" ReadOnly="true" />
                <MudButton Variant="Variant.Text" Color="Color.Secondary" Disabled="ViewModel.IsAuthBusy" OnClick="HandleLogoutAsync">
                    Sign out
                </MudButton>
            }
            else
            {
                <MudText Typo="Typo.body2">@ViewModel.AuthStatusLabel</MudText>
                <MudTextField Label="User name" @bind-Value="ViewModel.UserName" Disabled="ViewModel.IsAuthBusy" />
                <MudTextField Label="Password" InputType="InputType.Password" @bind-Value="ViewModel.Password" Disabled="ViewModel.IsAuthBusy" />

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="ViewModel.IsAuthBusy" OnClick="HandleRegisterAsync">
                        Register
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="ViewModel.IsAuthBusy" OnClick="HandleLoginAsync">
                        Sign in
                    </MudButton>
                </MudStack>

                @if (!string.IsNullOrWhiteSpace(ViewModel.AuthError))
                {
                    <MudText Typo="Typo.caption" Color="Color.Error">@ViewModel.AuthError</MudText>
                }
            }
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    protected override void OnInitialized()
    {
        ViewModel.OnChange += HandleViewModelChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await ViewModel.InitializeAsync();
    }

    public void Dispose()
    {
        ViewModel.OnChange -= HandleViewModelChanged;
        ViewModel.Dispose();
    }

    private void HandleViewModelChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private Task HandleRegisterAsync()
    {
        return ViewModel.RegisterAsync();
    }

    private Task HandleLoginAsync()
    {
        return ViewModel.LoginAsync();
    }

    private Task HandleLogoutAsync()
    {
        return ViewModel.LogoutAsync();
    }
}
