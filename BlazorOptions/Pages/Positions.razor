@page "/positions"
@implements IAsyncDisposable
@inject PositionBuilderViewModel ViewModel
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using System.Linq
@using Microsoft.AspNetCore.Components.Web
@using BlazorOptions.Shared

<PageTitle>Positions</PageTitle>

<MudStack>
    <MudCard>
        <MudCardContent>
            <MudStack Spacing="2">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h4">Positions</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="2">
                        <MudSwipeArea Class="position-swipe-area" OnSwipeEnd="OnSwipeEnd">
                            <MudTabs Class="position-tabs"
                                             ActivePanelIndex="@_activeTabIndex"
                                             ActivePanelIndexChanged="OnTabChanged"
                                             AlwaysShowScrollButtons="false"
                                           
                                             Elevation="0"
                                             AddIconClass="d-none">
                                @for (var i = 0; i < ViewModel.Positions.Count; i++)
                                {
                                    var position = ViewModel.Positions[i];

                                    <MudTabPanel @key="position.Id" Text="@position.Id.ToString()">
                                        <TabContent>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="tab-header">
                                                <MudText Class="tab-name-label">@position.Pair</MudText>
                                            </MudStack>
                                        </TabContent>
                                    </MudTabPanel>
                                }
                            </MudTabs>
                        </MudSwipeArea>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudTooltip Text="Add position">
                                <MudIconButton Icon="@Icons.Material.Filled.AddCircle" Color="Color.Primary" OnClick="CreatePosition" />
                            </MudTooltip>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                                     Disabled="@(!HasActivePosition)"
                                     Dense="true"
                                     AnchorOrigin="Origin.BottomCenter"
                                     TransformOrigin="Origin.TopCenter"
                                     ListClass="tab-actions-menu">
                                <MudMenuItem Disabled="@(!HasActivePosition)" OnClick="OpenRenameDialogAsync">
                                    <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-2" /> Edit position
                                </MudMenuItem>
                                <MudMenuItem Disabled="@(!HasActivePosition)" OnClick="async () => await ConfirmAndRemovePositionAsync(ViewModel.SelectedPosition!)">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" Class="mr-2" /> Delete position
                                </MudMenuItem>
                            </MudMenu>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudStack>
        </MudCardContent>
        <MudCardContent Class="chart-container">
            <MudPaper Class="chart-surface" Elevation="0">
                <MudStack Spacing="2" Style="height:100%;">
                    <PayoffChart Config="@ViewModel.ChartConfig"
                                 PriceSelected="HandleChartPriceSelected"
                                 LegendSelectionChanged="HandleLegendSelectionChanged"
                                 Height="100%"
                                 Style="flex:1; min-height:400px;"
                                 @ref="_chart" />
                    <MudStack Spacing="1">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudText Typo="Typo.subtitle2">Valuation date</MudText>
                            <MudDatePicker Date="@ViewModel.SelectedValuationDate"
                                           DateChanged="OnValuationDateChanged"
                                           DateFormat="yyyy-MM-dd"
                                           Clearable="true"
                                           MinDate="@DateTime.UtcNow.Date"
                                           MaxDate="@ViewModel.MaxExpiryDate"
                                           Class="valuation-date-picker" />
                            <MudText Typo="Typo.caption">@ViewModel.DaysToExpiryLabel</MudText>
                            <MudSpacer />
                            <MudSwitch T="bool"
                                       Color="Color.Primary"
                                       Value="@ViewModel.IsLive"
                                       ValueChanged="OnLivePriceChanged"
                                       Label="Live" />
                            <MudText Typo="Typo.caption" Class="ml-2">Index Price</MudText>
                            <MudNumericField T="double?"
                                             Value="@ViewModel.SelectedPrice"
                                             ValueChanged="OnTemporaryPriceChanged"
                                             Immediate="true"
                                             Variant="Variant.Outlined"
                                             Margin="Margin.Dense"
                                             Adornment="Adornment.End"
                                             AdornmentText="USDT"
                                             Class="temp-price-field" />
                        </MudStack>
                        <MudSlider T="int"
                                   Min="0"
                                   Max="@ViewModel.MaxExpiryDays"
                                   Step="1"
                                   Value="@ViewModel.SelectedDayOffset"
                                   ValueChanged="OnValuationDateOffsetChanged"
                                   TickMarks="true"
                                   Class="valuation-date-slider" />
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudCardContent>
    </MudCard>

    <MudStack Spacing="2">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
            <MudText Typo="Typo.h6">Portfolios</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@(!HasActivePosition)"
                       OnClick="async () => await ViewModel.AddCollectionAsync()">
                Add portfolio
            </MudButton>
        </MudStack>
        @foreach (var collection in ViewModel.Collections)
        {
            <LegsPanel Collection="@collection" @key="collection.Id" />
        }
    </MudStack>
</MudStack>

<style>
    .position-swipe-area {
        display: block;
        flex: 1;
        min-width: 0;
    }

    .position-tabs .mud-tabs-toolbar {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .position-tabs .mud-tabs-toolbar-content {
        flex-wrap: nowrap;
    }

    .position-tabs .d-none {
        display: none !important;
    }

    .tab-name-field {
        min-width: 140px;
    }

    .tab-name-label {
        display: inline-block;
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding: 6px 12px;
    }

    .tab-actions-menu {
        min-width: 180px;
    }

    .temp-price-field {
        max-width: 180px;
    }

    .valuation-date-slider {
        padding: 0 14px 16px;
    }

    .valuation-date-picker {
        min-width: 140px;
        max-width: 170px;
        width: 170px;
    }

    .quick-leg-input {
        width: 220px;
    }
</style>

@code {
    private int _activeTabIndex;
    private PayoffChart? _chart;
    private bool HasActivePosition => ViewModel.SelectedPosition is not null;

    protected override async Task OnInitializedAsync()
    {
        ViewModel.OnChange += HandleViewModelChanged;
        ViewModel.NotificationRequested += HandleNotificationRequested;
        await ViewModel.InitializeAsync();
        SyncActiveTabIndex();
    }

    public async ValueTask DisposeAsync()
    {
        ViewModel.OnChange -= HandleViewModelChanged;
        ViewModel.NotificationRequested -= HandleNotificationRequested;
        await ViewModel.DisposeAsync();
    }

    private async Task HandleChartPriceSelected(double price)
    {
        ViewModel.SetSelectedPrice(price);
        await InvokeAsync(StateHasChanged);
    }

    private Task OnSwipeEnd(SwipeEventArgs args) => args.SwipeDirection switch
    {
        SwipeDirection.RightToLeft => ChangeTabByDelta(1),
        SwipeDirection.LeftToRight => ChangeTabByDelta(-1),
        _ => Task.CompletedTask
    };

    private async Task ChangeTabByDelta(int delta)
    {
        if (ViewModel.Positions.Count == 0)
        {
            return;
        }

        var nextIndex = Math.Clamp(_activeTabIndex + delta, 0, ViewModel.Positions.Count - 1);

        if (nextIndex != _activeTabIndex)
        {
            await OnTabChanged(nextIndex);
        }
    }

    private async Task OnTemporaryPriceChanged(double? price)
    {
        var refresh = !ViewModel.IsLive;
        ViewModel.UpdateSelectedPrice(price, refresh);

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnLivePriceChanged(bool isEnabled)
    {
        await ViewModel.SetIsLiveAsync(isEnabled);
        await InvokeAsync(StateHasChanged);
    }

    private void HandleViewModelChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandleNotificationRequested(string message)
    {
        if (!string.IsNullOrWhiteSpace(message))
        {
            Snackbar.Add(message, Severity.Warning);
        }
    }

    private Task OnValuationDateChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            ViewModel.SetValuationDate(date.Value);
        }
        else
        {
            ViewModel.ResetValuationDateToToday();
        }

        return InvokeAsync(StateHasChanged);
    }

    private Task OnValuationDateOffsetChanged(int offset)
    {
        ViewModel.SetValuationDateFromOffset(offset);
        return InvokeAsync(StateHasChanged);
    }

    private Task HandleLegendSelectionChanged(LegendSelectionChangedEventArgs args)
    {
        return ViewModel.UpdateCollectionVisibilityAsync(args.CollectionId, args.IsVisible);
    }

    private async Task CreatePosition()
    {
        await ViewModel.AddPositionAsync();
        _activeTabIndex = Math.Max(0, ViewModel.Positions.Count - 1);
        await RefreshChartAsync();
    }

    private void SyncActiveTabIndex()
    {
        var selectedIndex = ViewModel.SelectedPosition is null ? -1 : ViewModel.Positions.IndexOf(ViewModel.SelectedPosition);

        if (selectedIndex >= 0)
        {
            _activeTabIndex = selectedIndex;
        }
        else if (ViewModel.Positions.Count > 0)
        {
            _activeTabIndex = 0;
        }
    }

    private async Task OnTabChanged(int index)
    {
        if (index < 0 || index >= ViewModel.Positions.Count)
        {
            SyncActiveTabIndex();
            return;
        }

        var positionId = ViewModel.Positions[index].Id;

        if (await ViewModel.SelectPositionAsync(positionId))
        {
            _activeTabIndex = index;
            await RefreshChartAsync();
        }
    }

    private async Task OnCloseTab(MudTabPanel panel)
    {
        if (panel?.Text is null || !Guid.TryParse(panel.Text, out var positionId))
        {
            return;
        }

        await ConfirmAndRemovePositionAsync(positionId);
    }

    private async Task OpenRenameDialogAsync()
    {
        if (ViewModel.SelectedPosition is null)
        {
            return;
        }

        var parameters = new DialogParameters
        {
            [nameof(PositionNameDialog.InitialName)] = ViewModel.SelectedPosition.Pair
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<PositionNameDialog>("Edit position", parameters, options);
        var result = await dialog.Result;

        if (result is null || result.Canceled || result.Data is not string name)
        {
            return;
        }

        var active = ViewModel.SelectedPosition;

        if (active is null)
        {
            return;
        }

        await ViewModel.UpdatePairAsync(active, name);
        StateHasChanged();
    }

    private async Task ConfirmAndRemovePositionAsync(PositionModel position)
    {
        await ConfirmAndRemovePositionAsync(position.Id, position.Pair);
    }

    private async Task ConfirmAndRemovePositionAsync(Guid positionId, string? pair = null)
    {
        var position = ViewModel.Positions.FirstOrDefault(p => p.Id == positionId);

        if (position is null)
        {
            return;
        }

        var confirmed = await DialogService.ShowMessageBox("Remove position?", $"Delete {pair ?? position.Pair} and its chart view?", yesText: "Delete", cancelText: "Cancel");

        if (confirmed != true)
        {
            return;
        }

        if (await ViewModel.RemovePositionAsync(positionId))
        {
            if (_chart is not null)
            {
                await _chart.ClearRangesAsync(positionId);
            }
            SyncActiveTabIndex();
            await RefreshChartAsync();
        }
    }

    private Task RefreshChartAsync()
    {
        ViewModel.UpdateChart();
        return InvokeAsync(StateHasChanged);
    }

}
