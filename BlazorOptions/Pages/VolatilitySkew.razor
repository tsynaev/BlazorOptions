@page "/volatility-skew"
@implements IDisposable
@inject VolatilitySkewViewModel ViewModel
@using BlazorOptions.API.Positions

<PageTitle>Volatility Skew</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4">Volatility Skew</MudText>
    <MudText Typo="Typo.body2">Strike vs IV% with mark-IV line and bid/ask-IV markers.</MudText>

    <MudPaper Class="pa-4">
        <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="2" AlignItems="AlignItems.End">
            <MudSelect T="string"
                       Label="Instrument"
                       Value="@ViewModel.SelectedInstrument"
                       ValueChanged="OnInstrumentChanged"
                       Dense="true">
                @foreach (var instrument in ViewModel.AvailableInstruments)
                {
                    <MudSelectItem T="string" Value="@instrument" @key="instrument">@instrument</MudSelectItem>
                }
            </MudSelect>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="ViewModel.IsLoading"
                       OnClick="LoadAsync">
                @(ViewModel.IsLoading ? "Loading..." : "Load")
            </MudButton>
        </MudStack>

        <MudRadioGroup T="LegType"
                       Value="ViewModel.SelectedType"
                       ValueChanged="OnOptionTypeChanged"
                       Class="mt-2">
            <MudRadio T="LegType" Value="LegType.Call" Dense="true">Calls</MudRadio>
            <MudRadio T="LegType" Value="LegType.Put" Dense="true">Puts</MudRadio>
        </MudRadioGroup>

        @if (ViewModel.ExpirationChips.Count > 0)
        {
            <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mt-3">
                @foreach (var chip in ViewModel.ExpirationChips)
                {
                    <MudChip T="string" @key="chip.ExpirationDate"
                             Color="Color.Default"
                             Variant="@(chip.IsSelected ? Variant.Filled : Variant.Outlined)"
                             Style="@GetChipStyle(chip)"
                             OnClick="@(() => ToggleExpirationAsync(chip.ExpirationDate))">
                        @chip.Label
                    </MudChip>
                }
            </MudStack>
        }

        @if (!string.IsNullOrWhiteSpace(ViewModel.ErrorMessage))
        {
            <MudAlert Severity="Severity.Warning" Class="mt-2">@ViewModel.ErrorMessage</MudAlert>
        }
    </MudPaper>

    @if (ViewModel.Chart is not null)
    {
        <MudPaper Class="pa-2">
            <VolatilitySkewChart Config="ViewModel.Chart" Height="520px" />
        </MudPaper>
    }

    @if (ViewModel.SurfaceChart is not null)
    {
        <MudPaper Class="pa-2">
            <MudText Typo="Typo.h6" Class="px-2 pt-2">IV Surface</MudText>
            <VolatilitySkewSurfaceChart Config="ViewModel.SurfaceChart" Height="560px" />
        </MudPaper>
    }
</MudStack>

@code {
    protected override async Task OnInitializedAsync()
    {
        ViewModel.PropertyChanged += HandleViewModelChanged;
        await ViewModel.InitializeAsync();
    }

    public void Dispose()
    {
        ViewModel.PropertyChanged -= HandleViewModelChanged;
    }

    private Task OnInstrumentChanged(string value) => ViewModel.SetInstrumentAsync(value);

    private Task LoadAsync() => ViewModel.LoadAsync();

    private Task ToggleExpirationAsync(DateTime expirationDate) => ViewModel.ToggleExpirationAsync(expirationDate);

    private Task OnOptionTypeChanged(LegType type)
    {
        return ViewModel.SetOptionTypeAsync(type);
    }

    private void HandleViewModelChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private static string GetChipStyle(VolatilitySkewExpirationChip chip)
    {
        if (chip.IsSelected)
        {
            return $"border-color:{chip.ColorHex};color:#ffffff;background:{chip.ColorHex};";
        }

        return $"border-color:{chip.ColorHex};color:{chip.ColorHex};";
    }
}
